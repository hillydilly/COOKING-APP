<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hillard Family Recipe App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,400;0,9..144,500;0,9..144,600;1,9..144,400&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
    <style>
        /* ===== CSS VARIABLES ===== */
        :root {
            --primary: #4a7c59;
            --primary-dark: #3d6649;
            --primary-light: #e8f5e9;
            --bg-primary: #faf9f6;
            --bg-secondary: #f0ede8;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #444444;
            --text-muted: #777777;
            --border-color: #e0dcd5;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --font-display: 'Fraunces', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --header-height: 70px;
            --mobile-nav-height: 65px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }
        h1, h2, h3, h4 { font-family: var(--font-display); font-weight: 500; line-height: 1.3; }
        a { color: var(--primary); text-decoration: none; }
        a:hover { text-decoration: underline; }
        img { max-width: 100%; display: block; }

        /* Loading */
        .loading-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg-primary);
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-content { text-align: center; }
        .loading-logo { font-size: 3rem; margin-bottom: var(--space-md); animation: pulse 1.5s ease infinite; }
        .loading-text { font-family: var(--font-display); font-size: 1.5rem; color: var(--text-secondary); margin-bottom: var(--space-lg); }
        .loading-spinner {
            width: 36px; height: 36px; margin: 0 auto;
            border: 3px solid var(--border-color); border-top-color: var(--primary);
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Header */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(250,249,246,0.92); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
        }
        .header-inner {
            max-width: 1200px; margin: 0 auto;
            padding: 0 var(--space-lg);
            display: flex; align-items: center; justify-content: space-between;
            height: 100%;
        }
        .logo { display: flex; align-items: center; gap: var(--space-sm); }
        .logo-icon { font-size: 1.6rem; }
        .logo-text { font-family: var(--font-display); font-size: 1.25rem; font-weight: 500; }
        .nav-tabs { display: flex; gap: var(--space-xs); }
        .nav-tab {
            padding: 0.5rem 1rem; border: none; background: none;
            font-family: var(--font-body); font-size: 0.9rem; font-weight: 500;
            color: var(--text-muted); cursor: pointer; border-radius: 2rem; transition: all 0.2s;
        }
        .nav-tab:hover { color: var(--text-primary); background: var(--bg-secondary); }
        .nav-tab.active { color: white; background: var(--primary); }
        .header-actions { display: flex; gap: var(--space-sm); }
        @media (max-width: 768px) {
            .nav-tabs, .header-actions { display: none; }
            .header { height: 56px; }
            .header-inner { padding: 0 var(--space-md); }
        }

        /* Mobile Nav */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; right: 0;
            z-index: 100; background: rgba(250,249,246,0.95); backdrop-filter: blur(12px);
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .mobile-nav-inner { display: flex; justify-content: space-around; padding: 0.5rem 0; }
        .mobile-nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            background: none; border: none; padding: 0.4rem 0.8rem;
            font-family: var(--font-body); font-size: 0.7rem; font-weight: 500;
            color: var(--text-muted); cursor: pointer; border-radius: var(--radius-sm); transition: all 0.2s;
        }
        .mobile-nav-btn .icon { font-size: 1.3rem; }
        .mobile-nav-btn.active { color: var(--primary); }
        @media (max-width: 768px) {
            .mobile-nav { display: block; }
            body { padding-bottom: calc(var(--mobile-nav-height) + env(safe-area-inset-bottom)); }
        }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.6rem 1.2rem; border: none; border-radius: 2rem;
            font-family: var(--font-body); font-size: 0.9rem; font-weight: 500;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--border-color); }
        .btn-large { padding: 0.75rem 1.5rem; font-size: 1rem; }

        /* Main */
        .main { padding: var(--space-xl) 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 var(--space-lg); }
        @media (max-width: 768px) { .container { padding: 0 var(--space-md); } .main { padding: var(--space-lg) 0; } }

        /* Views */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        /* Daily */
        .daily-header { text-align: center; margin-bottom: var(--space-xl); }
        .daily-date { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .daily-title { font-size: 2rem; margin: var(--space-sm) 0; }
        .daily-subtitle { color: var(--text-secondary); }
        @media (max-width: 768px) { .daily-title { font-size: 1.5rem; } }

        .suggestion-toggle { display: flex; gap: var(--space-sm); justify-content: center; margin-bottom: var(--space-lg); }
        .suggestion-toggle-btn {
            padding: 0.5rem 1.25rem; border: 2px solid var(--border-color);
            background: white; border-radius: 2rem; font-family: var(--font-body);
            font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.2s;
        }
        .suggestion-toggle-btn.active { border-color: var(--primary); background: var(--primary-light); color: var(--primary-dark); }

        .suggestion-card {
            background: var(--bg-card); border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md); overflow: hidden; margin-bottom: var(--space-2xl);
        }
        .suggestion-content { display: flex; gap: var(--space-lg); }
        .suggestion-image { width: 300px; height: 280px; object-fit: cover; flex-shrink: 0; }
        .suggestion-details { padding: var(--space-lg); flex: 1; }
        .suggestion-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: var(--space-sm); }
        .suggestion-recipe-name { font-family: var(--font-display); font-size: 1.6rem; margin-bottom: var(--space-sm); }
        .suggestion-meta { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-bottom: var(--space-sm); align-items: center; }
        .meta-item { font-size: 0.9rem; color: var(--text-secondary); }
        .suggestion-tags { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: var(--space-sm); }
        .suggestion-actions { display: flex; flex-wrap: wrap; gap: var(--space-sm); }
        .source-link { display: inline-block; font-size: 0.9rem; margin-bottom: var(--space-sm); color: var(--primary); }
        @media (max-width: 768px) {
            .suggestion-content { flex-direction: column; }
            .suggestion-image { width: 100%; height: 200px; }
            .suggestion-recipe-name { font-size: 1.3rem; }
        }

        .tag { display: inline-block; padding: 0.2rem 0.65rem; border-radius: 2rem; font-size: 0.75rem; font-weight: 500; background: var(--bg-secondary); color: var(--text-secondary); }
        .tag.dietary { background: #fff3e0; color: #e65100; }

        .meal-type-badge { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.25rem 0.75rem; border-radius: 2rem; font-size: 0.8rem; font-weight: 500; }
        .meal-type-badge.lunch { background: #e3f2fd; color: #1565c0; }
        .meal-type-badge.dinner { background: #fce4ec; color: #c62828; }

        /* Recipe Grid & Cards */
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-lg); }
        @media (max-width: 768px) { .recipe-grid { grid-template-columns: 1fr 1fr; gap: var(--space-md); } }
        @media (max-width: 500px) { .recipe-grid { grid-template-columns: 1fr; } }
        .recipe-card {
            background: var(--bg-card); border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm); overflow: hidden; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; position: relative;
        }
        .recipe-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-md); }
        .recipe-card-image { width: 100%; height: 160px; object-fit: cover; }
        .recipe-card-image-placeholder { width: 100%; height: 160px; display: flex; align-items: center; justify-content: center; background: var(--bg-secondary); font-size: 3rem; }
        .recipe-card-body { padding: var(--space-md); }
        .recipe-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: var(--space-sm); }
        .recipe-card-name { font-family: var(--font-display); font-size: 1rem; font-weight: 500; flex: 1; }
        .recipe-card-meta { display: flex; gap: var(--space-md); font-size: 0.8rem; color: var(--text-muted); margin-top: var(--space-xs); }
        .recipe-card-tags { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-top: var(--space-sm); }
        .favorite-btn { background: none; border: none; cursor: pointer; font-size: 1.1rem; transition: transform 0.2s; padding: 0; }
        .favorite-btn:hover { transform: scale(1.2); }
        .rotation-badge { position: absolute; top: var(--space-sm); right: var(--space-sm); background: rgba(0,0,0,0.7); color: white; padding: 0.2rem 0.6rem; border-radius: 2rem; font-size: 0.75rem; font-weight: 600; }
        .rotation-badge.available { background: var(--primary); }
        .card-meal-badge { position: absolute; top: var(--space-sm); left: var(--space-sm); background: rgba(255,255,255,0.9); padding: 0.15rem 0.5rem; border-radius: 2rem; font-size: 0.8rem; }

        .favorites-section { margin-top: var(--space-xl); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); }
        .section-title { font-size: 1.5rem; }

        /* Weekly */
        .weekly-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: var(--space-md); }
        .week-nav { display: flex; align-items: center; gap: var(--space-md); }
        .week-nav-btn { background: var(--bg-secondary); border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .week-nav-btn:hover { background: var(--border-color); }
        .week-title { font-size: 1.5rem; }
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: var(--space-sm); }
        @media (max-width: 768px) { .week-grid { grid-template-columns: 1fr; } }
        .day-card { background: var(--bg-card); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); overflow: hidden; }
        .day-card.today { border: 2px solid var(--primary); }
        .day-header { display: flex; justify-content: space-between; align-items: center; padding: 0.6rem 0.75rem; background: var(--bg-secondary); }
        .day-name { font-weight: 600; font-size: 0.85rem; }
        .day-date { font-size: 0.8rem; color: var(--text-muted); }
        .day-content { padding: 0.5rem; }
        .meal-slot { margin-bottom: 0.5rem; }
        .meal-slot-header { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); padding: 0.25rem 0.4rem; }
        .day-meal { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.5rem; background: var(--bg-secondary); border-radius: var(--radius-sm); margin-bottom: 0.25rem; font-size: 0.8rem; }
        .day-meal-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
        .day-meal-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.8rem; padding: 0 0.25rem; opacity: 0.5; }
        .day-meal-remove:hover { opacity: 1; color: #ef5350; }
        .day-add-btn { width: 100%; padding: 0.35rem; border: 1px dashed var(--border-color); border-radius: var(--radius-sm); background: none; font-family: var(--font-body); font-size: 0.75rem; color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
        .day-add-btn:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

        /* Shopping */
        .shopping-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: var(--space-md); }
        .shopping-title { font-size: 2rem; }
        .shopping-subtitle { color: var(--text-muted); }
        .shopping-actions { display: flex; gap: var(--space-sm); flex-wrap: wrap; }
        .shopping-categories { display: grid; gap: var(--space-lg); }

        /* Recipes View */
        .recipes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-lg); flex-wrap: wrap; gap: var(--space-md); }
        .recipes-title { font-size: 2rem; }
        .search-input { padding: 0.6rem 1.2rem; border: 1px solid var(--border-color); border-radius: 2rem; font-family: var(--font-body); font-size: 0.9rem; background: white; width: 250px; transition: border-color 0.2s; }
        .search-input:focus { outline: none; border-color: var(--primary); }
        .stats-bar { display: flex; gap: var(--space-lg); margin-bottom: var(--space-lg); padding: var(--space-md) var(--space-lg); background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); flex-wrap: wrap; }
        .stat-item { text-align: center; min-width: 80px; }
        .stat-value { font-family: var(--font-display); font-size: 1.5rem; font-weight: 600; color: var(--primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .filter-chips { display: flex; gap: var(--space-sm); margin-bottom: var(--space-lg); flex-wrap: wrap; }
        .filter-chip { padding: 0.4rem 1rem; border: 1px solid var(--border-color); background: white; border-radius: 2rem; font-family: var(--font-body); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .filter-chip:hover { background: var(--bg-secondary); }
        .filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; z-index: 1000; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; padding: var(--space-lg); }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-card); border-radius: var(--radius-xl); box-shadow: var(--shadow-lg); width: 100%; max-width: 550px; max-height: 85vh; display: flex; flex-direction: column; animation: modalIn 0.25s ease; }
        .modal-large { max-width: 700px; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg); border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 1.25rem; }
        .modal-close { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s; }
        .modal-close:hover { background: var(--bg-secondary); }
        .modal-body { padding: var(--space-lg); overflow-y: auto; flex: 1; }
        .modal-footer { display: flex; justify-content: flex-end; gap: var(--space-sm); padding: var(--space-md) var(--space-lg); border-top: 1px solid var(--border-color); }

        /* Forms */
        .form-group { margin-bottom: var(--space-md); }
        .form-label { display: block; font-weight: 500; font-size: 0.9rem; margin-bottom: 0.35rem; }
        .form-input { width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm); font-family: var(--font-body); font-size: 0.9rem; background: white; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary); }
        .form-textarea { width: 100%; padding: 0.6rem 0.9rem; border: 1px solid var(--border-color); border-radius: var(--radius-sm); font-family: var(--font-body); font-size: 0.9rem; min-height: 100px; resize: vertical; background: white; }
        .form-textarea:focus { outline: none; border-color: var(--primary); }
        .form-hint { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }
        .form-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-md); }
        @media (max-width: 500px) { .form-row { grid-template-columns: 1fr 1fr; } }
        .url-import-section { margin-bottom: var(--space-lg); }
        .url-import-row { display: flex; gap: var(--space-sm); }
        .url-import-row .form-input { flex: 1; }
        .divider { display: flex; align-items: center; gap: var(--space-md); margin: var(--space-lg) 0; color: var(--text-muted); font-size: 0.85rem; }
        .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }
        .meal-type-toggle { display: flex; gap: var(--space-sm); }
        .meal-type-btn { padding: 0.5rem 1rem; border: 2px solid var(--border-color); background: white; border-radius: 2rem; font-family: var(--font-body); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .meal-type-btn.active { border-color: var(--primary); background: var(--primary-light); }

        /* Recipe Detail */
        .recipe-detail-image { width: 100%; max-height: 300px; object-fit: cover; }
        .recipe-detail-header { padding: var(--space-lg); }
        .recipe-detail-name { font-size: 1.5rem; margin-bottom: var(--space-sm); }
        .recipe-detail-meta { display: flex; flex-wrap: wrap; gap: var(--space-sm); margin-bottom: var(--space-sm); align-items: center; }
        .recipe-detail-section { padding: 0 var(--space-lg) var(--space-lg); }
        .recipe-detail-section-title { font-size: 1.1rem; margin-bottom: var(--space-md); }
        .ingredient-list { list-style: none; padding: 0; }
        .ingredient-item { padding: 0.4rem 0; border-bottom: 1px solid var(--bg-secondary); font-size: 0.95rem; }
        .instruction-list { padding-left: 1.25rem; }
        .instruction-item { padding: 0.5rem 0; font-size: 0.95rem; line-height: 1.6; }
        .empty-details { text-align: center; padding: var(--space-xl); color: var(--text-muted); }
        .recipe-selector { display: flex; flex-direction: column; gap: var(--space-sm); max-height: 400px; overflow-y: auto; }
        .recipe-selector-item { display: flex; gap: var(--space-md); padding: var(--space-sm); align-items: center; border-radius: var(--radius-md); cursor: pointer; transition: background 0.2s; }
        .recipe-selector-item:hover { background: var(--primary-light); }
        .recipe-selector-item.unavailable { opacity: 0.5; cursor: not-allowed; }
        .recipe-selector-thumb { width: 50px; height: 50px; border-radius: var(--radius-sm); object-fit: cover; flex-shrink: 0; background: var(--bg-secondary); }
        .recipe-selector-info { flex: 1; }
        .recipe-selector-name { font-weight: 500; font-size: 0.9rem; }
        .recipe-selector-meta { font-size: 0.8rem; color: var(--text-muted); }

        /* Toast */
        .toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 9000; display: flex; flex-direction: column; gap: var(--space-sm); }
        .toast { background: var(--text-primary); color: white; padding: 0.75rem 1.5rem; border-radius: 2rem; font-size: 0.9rem; box-shadow: var(--shadow-lg); animation: toastIn 0.3s ease; transition: opacity 0.3s; white-space: nowrap; }
        .toast.success { background: var(--primary); }
        .toast.error { background: #ef5350; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .sync-indicator { position: fixed; top: 80px; right: 20px; z-index: 200; background: var(--primary); color: white; padding: 0.4rem 1rem; border-radius: 2rem; font-size: 0.8rem; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .sync-indicator.visible { opacity: 1; }
        .empty-state { text-align: center; padding: var(--space-2xl); }
        .empty-state-icon { font-size: 3rem; margin-bottom: var(--space-md); }
        .empty-state-title { font-size: 1.25rem; margin-bottom: var(--space-sm); }
        .image-preview { margin-top: var(--space-sm); }
        .image-preview img { max-height: 150px; border-radius: var(--radius-sm); }
    </style>
    <style>
        /* Serving Multiplier Styles */
        .section-header-with-multiplier {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .serving-multiplier {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-secondary, #f5f5f5);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
        }
        .multiplier-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--primary, #4a7c59);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .multiplier-btn:hover:not(:disabled) {
            background: var(--primary-dark, #3d6649);
            transform: scale(1.1);
        }
        .multiplier-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .multiplier-value {
            font-weight: 600;
            min-width: 2rem;
            text-align: center;
        }
        .multiplier-label {
            color: var(--text-muted, #666);
            font-size: 0.85rem;
        }
        
        /* Recently Checked Section */
        .recently-checked-section {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            grid-column: 1 / -1;
        }
        .recently-checked-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .recently-checked-icon {
            font-size: 1.25rem;
        }
        .recently-checked-title {
            font-weight: 600;
            flex: 1;
            color: var(--text-primary, #1a1a1a);
        }
        .recently-checked-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .recently-checked-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: line-through;
            color: var(--text-muted, #666);
        }
        .recently-checked-item:hover {
            background: #ffebee;
        }
        .recently-checked-item .item-remove {
            color: #ef5350;
            font-weight: bold;
        }
        
        /* Simplified Shopping List Styles */
        .shopping-section {
            grid-column: 1 / -1;
            margin-bottom: 2rem;
        }
        .shopping-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color, #e0e0e0);
        }
        .shopping-section-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .shopping-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .shopping-category {
            background: var(--bg-secondary, #f8f8f8);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .category-label {
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            color: var(--text-primary, #333);
        }
        .category-items-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .shopping-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }
        .shopping-item:hover {
            background: #e8f5e9;
            border-color: #a5d6a7;
        }
        .shopping-item:active {
            transform: scale(0.98);
        }
        .item-checkbox {
            color: #9e9e9e;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        .item-text {
            flex: 1;
            line-height: 1.4;
        }
        
        /* In Cart Section */
        .shopping-section.in-cart {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 1rem;
            padding: 1.25rem;
        }
        .shopping-section.in-cart .shopping-section-header {
            border-bottom-color: rgba(0,0,0,0.1);
        }
        .cart-items {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .cart-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: line-through;
            color: var(--text-muted, #666);
        }
        .cart-item:hover {
            background: #ffebee;
            text-decoration: none;
        }
        .item-check {
            color: #4caf50;
            font-weight: bold;
        }
        
        /* Shopping Complete */
        .shopping-complete {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted, #666);
        }
        .complete-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Discover Description */
        .discover-description {
            color: var(--text-secondary, #444);
            font-size: 1rem;
            line-height: 1.5;
            margin: 0.75rem 0;
            font-style: italic;
        }
        
        /* Recipe Selector Improvements */
        .recipe-selector-item.already-selected {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--bg-secondary, #f0f0f0);
        }
        .selector-meal-badge {
            display: inline-block;
            margin-right: 0.25rem;
        }
        
        /* Small Button */
        .btn-small {
            padding: 0.35rem 0.75rem;
            font-size: 0.8rem;
        }
        
        /* Recipes Header Actions */
        .recipes-header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        /* Pantry Stock Styles */
        .pantry-stock-section {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 1rem;
            padding: 1.25rem;
            margin-top: 1rem;
        }
        .stock-description {
            color: var(--text-muted, #666);
            font-size: 0.9rem;
            margin: 0.5rem 0 1rem;
        }
        .stock-items-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .stock-tag {
            background: white;
            padding: 0.35rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.85rem;
            color: var(--text-primary, #333);
        }
        .stock-more {
            padding: 0.35rem 0.75rem;
            font-size: 0.85rem;
            color: var(--text-muted, #666);
        }
        .no-stock {
            color: var(--text-muted, #666);
            font-style: italic;
            margin: 0;
        }
        
        /* Add to stock button */
        .add-to-stock-btn {
            background: none;
            border: none;
            cursor: pointer;
            opacity: 0.4;
            padding: 0.25rem;
            font-size: 0.9rem;
            transition: opacity 0.2s;
        }
        .shopping-item:hover .add-to-stock-btn {
            opacity: 1;
        }
        .add-to-stock-btn:hover {
            transform: scale(1.2);
        }
        
        /* Stock Manager Modal Styles */
        .stock-manager-add {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .stock-manager-add .form-input {
            flex: 1;
        }
        .stock-manager-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .stock-manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-secondary, #f5f5f5);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .stock-manager-item span {
            flex: 1;
        }
        .btn-danger {
            background: #ef5350;
            color: white;
        }
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        /* Stock Manager Tabs */
        .stock-manager-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color, #e0e0e0);
            padding-bottom: 0.5rem;
        }
        .stock-tab {
            background: none;
            border: none;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .stock-tab:hover {
            background: var(--bg-secondary, #f5f5f5);
        }
        .stock-tab.active {
            background: var(--primary, #4a7c59);
            color: white;
        }
        .stock-tab-content {
            display: none;
        }
        .stock-tab-content.active {
            display: block;
        }
        
        /* Photo Capture */
        .photo-capture-section {
            padding: 1rem 0;
        }
        .photo-instructions {
            color: var(--text-muted, #666);
            margin-bottom: 1rem;
        }
        .photo-buttons {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .photo-upload-btn {
            cursor: pointer;
        }
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .analyzing-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted, #666);
        }
        .loading-spinner-small {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color, #e0e0e0);
            border-top-color: var(--primary, #4a7c59);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .photo-result-form {
            background: var(--bg-secondary, #f5f5f5);
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .photo-result-form p {
            margin: 0 0 0.5rem;
            font-weight: 500;
        }
        .photo-result-form .btn {
            margin-top: 0.75rem;
        }
        
        /* Stock Items with Photos */
        .stock-manager-list-header {
            margin: 1.5rem 0 0.75rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color, #e0e0e0);
        }
        .stock-manager-list-header h4 {
            margin: 0;
            color: var(--text-muted, #666);
            font-weight: 500;
        }
        .stock-manager-item.has-photo {
            padding: 0.5rem;
        }
        .stock-item-photo {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 0.5rem;
            cursor: pointer;
        }
        .stock-item-no-photo {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary, #e8e8e8);
            border-radius: 0.5rem;
            font-size: 1.5rem;
        }
        .stock-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-left: 0.75rem;
        }
        .stock-item-name {
            font-weight: 500;
        }
        .stock-item-details {
            font-size: 0.85rem;
            color: var(--text-muted, #666);
        }
        
        /* Photo Lightbox */
        .photo-lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            text-align: center;
        }
        .lightbox-content img {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 0.5rem;
        }
        .lightbox-info {
            color: white;
            margin-top: 1rem;
        }
        .lightbox-info h3 {
            margin: 0;
        }
        .lightbox-info p {
            margin: 0.5rem 0 0;
            opacity: 0.8;
        }
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">üè†</div>
            <div class="loading-text">Hillard Family Recipes</div>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <header class="header">
        <div class="header-inner">
            <div class="logo">
                <div class="logo-icon">üè†</div>
                <div class="logo-text">Hillard Family</div>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-view="daily">Today</button>
                <button class="nav-tab" data-view="weekly">Weekly Plan</button>
                <button class="nav-tab" data-view="shopping">Shopping</button>
                <button class="nav-tab" data-view="recipes">Recipes</button>
            </nav>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="openAddRecipeModal()"><span>+</span> <span>Add Recipe</span></button>
            </div>
        </div>
    </header>

    <nav class="mobile-nav">
        <div class="mobile-nav-inner">
            <button class="mobile-nav-btn active" data-view="daily"><span class="icon">üçΩÔ∏è</span>Today</button>
            <button class="mobile-nav-btn" data-view="weekly"><span class="icon">üìÖ</span>Week</button>
            <button class="mobile-nav-btn" data-view="shopping"><span class="icon">üõí</span>Shop</button>
            <button class="mobile-nav-btn" data-view="recipes"><span class="icon">üìñ</span>Recipes</button>
        </div>
    </nav>

    <main class="main">
        <div class="container">
            <!-- DAILY VIEW -->
            <div id="daily-view" class="view active">
                <div class="daily-header">
                    <div class="daily-date" id="current-date"></div>
                    <h1 class="daily-title">What's cooking today?</h1>
                    <p class="daily-subtitle">Choose from your favorites or discover something new</p>
                </div>
                
                <!-- Suggestion Buttons -->
                <div class="suggestion-toggle">
                    <button class="suggestion-toggle-btn active" data-type="favorite" onclick="setSuggestionType('favorite')">‚ù§Ô∏è From Favorites</button>
                    <button class="suggestion-toggle-btn" data-type="discover" onclick="setSuggestionType('discover')">‚ú® Discover New</button>
                </div>
                
                <div class="suggestion-card" id="daily-suggestion"></div>
                
                <div class="favorites-section">
                    <div class="section-header"><h2 class="section-title">Your Favorites</h2></div>
                    <div class="recipe-grid" id="favorites-grid"></div>
                </div>
            </div>

            <!-- WEEKLY VIEW -->
            <div id="weekly-view" class="view">
                <div class="weekly-header">
                    <div class="week-nav">
                        <button class="week-nav-btn" onclick="changeWeek(-1)">‚Üê</button>
                        <h2 class="week-title" id="week-title">This Week</h2>
                        <button class="week-nav-btn" onclick="changeWeek(1)">‚Üí</button>
                    </div>
                    <button class="btn btn-primary" onclick="generateWeeklyPlan()">‚ú® <span>Auto-fill Week</span></button>
                </div>
                <div class="week-grid" id="week-grid"></div>
            </div>

            <!-- SHOPPING VIEW -->
            <div id="shopping-view" class="view">
                <div class="shopping-header">
                    <div>
                        <h1 class="shopping-title">Shopping List</h1>
                        <p class="shopping-subtitle" id="shopping-subtitle">Based on your weekly plan</p>
                    </div>
                    <div class="shopping-actions">
                        <button class="btn btn-secondary" onclick="clearCheckedItems()">Clear Checked</button>
                        <button class="btn btn-primary" onclick="regenerateShoppingList()">üîÑ <span>Regenerate</span></button>
                    </div>
                </div>
                <div class="shopping-categories" id="shopping-categories"></div>
            </div>

            <!-- RECIPES VIEW -->
            <div id="recipes-view" class="view">
                <div class="recipes-header">
                    <h1 class="recipes-title">Recipe Collection</h1>
                    <div class="recipes-header-actions">
                        <button class="btn btn-secondary btn-small" onclick="cleanAllRecipes()" title="Remove checkbox characters from all recipes">üßπ Clean Recipes</button>
                        <div class="recipes-search">
                            <input type="text" class="search-input" placeholder="Search recipes..." id="recipe-search" oninput="filterRecipes()">
                        </div>
                    </div>
                </div>
                <div class="stats-bar">
                    <div class="stat-item"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Total Recipes</div></div>
                    <div class="stat-item"><div class="stat-value" id="stat-available">0</div><div class="stat-label">Available Now</div></div>
                    <div class="stat-item"><div class="stat-value" id="stat-favorites">0</div><div class="stat-label">Favorites</div></div>
                    <div class="stat-item"><div class="stat-value" id="stat-rotation">21</div><div class="stat-label">Day Rotation</div></div>
                </div>
                <div class="filter-chips">
                    <button class="filter-chip active" data-filter="all">All</button>
                    <button class="filter-chip" data-filter="available">Available</button>
                    <button class="filter-chip" data-filter="favorites">Favorites</button>
                    <button class="filter-chip" data-filter="lunch">Lunch</button>
                    <button class="filter-chip" data-filter="dinner">Dinner</button>
                    <button class="filter-chip" data-filter="quick">Quick (&lt; 30 min)</button>
                </div>
                <div class="recipe-grid" id="all-recipes-grid"></div>
            </div>
        </div>
    </main>

    <!-- Add Recipe Modal -->
    <div class="modal-overlay" id="add-recipe-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Recipe</h3>
                <button class="modal-close" onclick="closeModal('add-recipe-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- URL Import Section -->
                <div class="url-import-section">
                    <div class="form-group">
                        <label class="form-label">Import from URL</label>
                        <div class="url-import-row">
                            <input type="url" class="form-input" id="import-url" placeholder="https://www.halfbakedharvest.com/recipe...">
                            <button class="btn btn-primary" onclick="importFromUrl()" id="import-btn">Import</button>
                        </div>
                        <p class="form-hint">Paste a recipe URL and we'll try to auto-fill the details</p>
                    </div>
                    <div class="divider"><span>or enter manually</span></div>
                </div>
                
                <form id="add-recipe-form" onsubmit="handleAddRecipe(event)">
                    <div class="form-group">
                        <label class="form-label">Recipe Name *</label>
                        <input type="text" class="form-input" name="name" id="add-name" required placeholder="e.g., Honey Garlic Salmon">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Meal Type</label>
                        <div class="meal-type-toggle">
                            <button type="button" class="meal-type-btn" data-meal="lunch" onclick="toggleMealType(this, 'add')">ü•ó Lunch</button>
                            <button type="button" class="meal-type-btn active" data-meal="dinner" onclick="toggleMealType(this, 'add')">üçΩÔ∏è Dinner</button>
                        </div>
                        <input type="hidden" name="mealType" id="add-mealType" value="dinner">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Prep Time (min)</label>
                            <input type="number" class="form-input" name="prepTime" id="add-prepTime" placeholder="15">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cook Time (min)</label>
                            <input type="number" class="form-input" name="cookTime" id="add-cookTime" placeholder="25">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Servings</label>
                            <input type="number" class="form-input" name="servings" id="add-servings" placeholder="4">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ingredients</label>
                        <textarea class="form-textarea" name="ingredients" id="add-ingredients" placeholder="One ingredient per line"></textarea>
                        <p class="form-hint">Enter one ingredient per line</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instructions</label>
                        <textarea class="form-textarea" name="instructions" id="add-instructions" placeholder="One step per line"></textarea>
                        <p class="form-hint">Enter one step per line</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <input type="text" class="form-input" name="tags" id="add-tags" placeholder="e.g., dinner, seafood, quick">
                        <p class="form-hint">Comma-separated tags</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source URL</label>
                        <input type="url" class="form-input" name="sourceUrl" id="add-sourceUrl" placeholder="https://halfbakedharvest.com/...">
                        <p class="form-hint">Link to original recipe for reference</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Image URL (optional)</label>
                        <input type="url" class="form-input" name="imageUrl" id="add-imageUrl" placeholder="https://...image.jpg">
                        <p class="form-hint">Direct link to a recipe photo</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('add-recipe-modal')">Cancel</button>
                <button class="btn btn-primary" type="submit" form="add-recipe-form">Add Recipe</button>
            </div>
        </div>
    </div>

    <!-- Recipe Detail Modal -->
    <div class="modal-overlay" id="recipe-detail-modal">
        <div class="modal modal-large">
            <div class="modal-header">
                <h3 class="modal-title">Recipe Details</h3>
                <button class="modal-close" onclick="closeModal('recipe-detail-modal')">‚úï</button>
            </div>
            <div id="recipe-detail-content"></div>
        </div>
    </div>

    <!-- Edit Recipe Modal -->
    <div class="modal-overlay" id="edit-recipe-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Recipe</h3>
                <button class="modal-close" onclick="closeModal('edit-recipe-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="edit-recipe-form" onsubmit="handleEditRecipe(event)">
                    <input type="hidden" name="id" id="edit-recipe-id">
                    <div class="form-group">
                        <label class="form-label">Recipe Name *</label>
                        <input type="text" class="form-input" name="name" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Meal Type</label>
                        <div class="meal-type-toggle" id="edit-meal-type-toggle">
                            <button type="button" class="meal-type-btn" data-meal="lunch" onclick="toggleMealType(this, 'edit')">ü•ó Lunch</button>
                            <button type="button" class="meal-type-btn" data-meal="dinner" onclick="toggleMealType(this, 'edit')">üçΩÔ∏è Dinner</button>
                        </div>
                        <input type="hidden" name="mealType" id="edit-mealType" value="dinner">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Prep Time (min)</label>
                            <input type="number" class="form-input" name="prepTime" id="edit-prepTime">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cook Time (min)</label>
                            <input type="number" class="form-input" name="cookTime" id="edit-cookTime">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Servings</label>
                            <input type="number" class="form-input" name="servings" id="edit-servings">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ingredients</label>
                        <textarea class="form-textarea" name="ingredients" id="edit-ingredients"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instructions</label>
                        <textarea class="form-textarea" name="instructions" id="edit-instructions"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tags</label>
                        <input type="text" class="form-input" name="tags" id="edit-tags">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Source URL</label>
                        <input type="url" class="form-input" name="sourceUrl" id="edit-sourceUrl" placeholder="https://...">
                        <p class="form-hint">Link to original recipe</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Image URL</label>
                        <input type="url" class="form-input" name="imageUrl" id="edit-imageUrl" placeholder="https://...image.jpg">
                        <p class="form-hint">Direct link to a recipe photo</p>
                    </div>
                    <div id="edit-image-preview" class="image-preview"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-recipe-modal')">Cancel</button>
                <button class="btn btn-primary" type="submit" form="edit-recipe-form">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Select Recipe Modal -->
    <div class="modal-overlay" id="select-recipe-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="select-recipe-title">Select Recipe</h3>
                <button class="modal-close" onclick="closeModal('select-recipe-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input" id="recipe-selector-search" placeholder="Search recipes..." oninput="filterRecipeSelector()" style="margin-bottom: var(--space-lg);">
                <div class="recipe-selector" id="recipe-selector"></div>
            </div>
        </div>
    </div>

    <!-- Stock Manager Modal -->
    <div class="modal-overlay" id="stock-manager-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">üè† Manage Pantry Stock</h3>
                <button class="modal-close" onclick="closeModal('stock-manager-modal')">‚úï</button>
            </div>
            <div class="modal-body" id="stock-manager-content">
                <!-- Content populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('stock-manager-modal')">Done</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- App -->

    <script>
    // ===== FIREBASE CONFIG =====
    const firebaseConfig = {
        apiKey: "AIzaSyCYUZMB052YNUMXmv8VbNDlKR6gSimKPhk",
        authDomain: "recipe-app-96183.firebaseapp.com",
        projectId: "recipe-app-96183",
        storageBucket: "recipe-app-96183.firebasestorage.app",
        messagingSenderId: "181306175586",
        appId: "1:181306175586:web:871982f5a6b8b8b20de13b",
        measurementId: "G-QTPGNJ6VRL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const USER_ID = 'hillard-family';
    const COLLECTIONS = { RECIPES: 'recipes', WEEKLY_PLANS: 'weeklyPlans', SETTINGS: 'settings' };
    </script>

    <script>
// ===== APP STATE =====
const ROTATION_DAYS = 21;
let currentWeekOffset = 0;
let selectedDayForRecipe = null;
let selectedMealSlot = null; // 'lunch' or 'dinner'
let currentFilter = 'all';
let suggestionType = 'favorite'; // 'favorite' or 'discover'
let appData = { recipes: [], weeklyPlan: {}, checkedItems: [], pantryStock: [] };
let pendingPhotoData = null; // Stores base64 photo data for stock items

// ===== FIREBASE DATA LAYER =====
const FirebaseDB = {
    async loadRecipes() {
        const snapshot = await db.collection(COLLECTIONS.RECIPES).where('userId', '==', USER_ID).get();
        const recipes = [];
        snapshot.forEach(doc => recipes.push({ id: doc.id, ...doc.data() }));
        return recipes;
    },
    async addRecipe(recipe) {
        const docRef = await db.collection(COLLECTIONS.RECIPES).add({ ...recipe, userId: USER_ID, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        return { id: docRef.id, ...recipe };
    },
    async updateRecipe(id, updates) {
        await db.collection(COLLECTIONS.RECIPES).doc(id).update({ ...updates, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    },
    async deleteRecipe(id) {
        await db.collection(COLLECTIONS.RECIPES).doc(id).delete();
    },
    async loadWeeklyPlan() {
        const doc = await db.collection(COLLECTIONS.WEEKLY_PLANS).doc(USER_ID).get();
        return doc.exists ? (doc.data().plan || {}) : {};
    },
    async saveWeeklyPlan(plan) {
        await db.collection(COLLECTIONS.WEEKLY_PLANS).doc(USER_ID).set({ plan, userId: USER_ID, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    },
    async loadSettings() {
        const doc = await db.collection(COLLECTIONS.SETTINGS).doc(USER_ID).get();
        return doc.exists ? doc.data() : { checkedItems: [], pantryStock: [] };
    },
    async saveSettings(settings) {
        await db.collection(COLLECTIONS.SETTINGS).doc(USER_ID).set({ ...settings, userId: USER_ID, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
    },
    async initializeDefaultRecipes() {
        const recipes = await this.loadRecipes();
        if (recipes.length === 0) {
            for (const recipe of getDefaultRecipes()) await this.addRecipe(recipe);
            return await this.loadRecipes();
        }
        return recipes;
    }
};

// ===== DEFAULT RECIPES (Your original favorites with source URLs) =====
function getDefaultRecipes() {
    return [
        { name: '20 Minute Grilled Jerk Chicken with Mango-Nectarine Salsa', prepTime: 10, cookTime: 10, servings: 4, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'chicken', 'grilled', 'quick'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/20-minute-grilled-jerk-chicken-with-mango-nectarine-salsa/', imageUrl: '' },
        { name: 'Heirloom Tomato Pomodoro Penne Pasta', prepTime: 15, cookTime: 40, servings: 6, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'pasta', 'italian', 'vegetarian'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/heirloom-tomato-pomodoro-penne-pasta/', imageUrl: '' },
        { name: 'Steak Fajitas with Chimichurri and Cucumber Salsa', prepTime: 10, cookTime: 15, servings: 6, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'beef', 'mexican', 'fajitas'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/steak-fajitas-chimichurri-cucumber-salsa/', imageUrl: '' },
        { name: '20 Minute Basil Cashew Chicken', prepTime: 10, cookTime: 10, servings: 4, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'chicken', 'asian', 'quick', 'thai'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/20-minute-basil-cashew-chicken/', imageUrl: '' },
        { name: 'Korean Chicken Bowl', prepTime: 15, cookTime: 15, servings: 4, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'chicken', 'korean', 'bowl', 'asian'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/korean-chicken-bowl/', imageUrl: '' },
        { name: 'Chicken Pho', prepTime: 15, cookTime: 45, servings: 6, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'soup', 'vietnamese', 'chicken', 'asian'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/chicken-pho/', imageUrl: '' },
        { name: 'Skillet Moroccan Chicken', prepTime: 15, cookTime: 35, servings: 4, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'chicken', 'moroccan', 'one-pan'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/skillet-moroccan-chicken/', imageUrl: '' },
        { name: 'Egg Drop Chicken Rice Soup', prepTime: 10, cookTime: 20, servings: 4, mealType: 'lunch', ingredients: [], instructions: [], tags: ['lunch', 'soup', 'chicken', 'asian', 'comfort'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/egg-drop-chicken-rice-soup/', imageUrl: '' },
        { name: 'Instant Pot Pesto Zuppa Toscana', prepTime: 15, cookTime: 20, servings: 6, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'soup', 'instant-pot', 'italian'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/instant-pot-pesto-zuppa-toscana/', imageUrl: '' },
        { name: 'Chicken Gyros Souvlaki with Tzatziki', prepTime: 20, cookTime: 15, servings: 4, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'chicken', 'greek', 'mediterranean'], favorite: true, lastCooked: null, sourceUrl: 'https://www.cookingclassy.com/gyros-chicken-souvlaki-tzatkiki-homemade-greek-flatbread/', imageUrl: '' },
        { name: 'Crockpot Spicy Chicken Tortilla Soup', prepTime: 15, cookTime: 240, servings: 6, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'soup', 'mexican', 'crockpot', 'chicken'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/crockpot-spicy-chicken-tortilla-soup/', imageUrl: '' },
        { name: 'Thai Drunken Noodles', prepTime: 15, cookTime: 15, servings: 4, mealType: 'dinner', ingredients: [], instructions: [], tags: ['dinner', 'noodles', 'thai', 'asian', 'spicy'], favorite: true, lastCooked: null, sourceUrl: 'https://www.halfbakedharvest.com/better-than-takeout-thai-drunken-noodles/', imageUrl: '' }
    ];
}

// ===== UTILITIES =====
function formatDate(date) { return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }); }
function getDaysSinceCooked(r) { return r.lastCooked ? Math.ceil(Math.abs(new Date() - new Date(r.lastCooked)) / 86400000) : Infinity; }
function isRecipeAvailable(r) { return getDaysSinceCooked(r) >= ROTATION_DAYS; }
function getRecipeEmoji(r) {
    const t = r.tags || [], n = r.name.toLowerCase();
    if (t.includes('seafood') || /salmon|shrimp|cod|fish/.test(n)) return 'üêü';
    if (t.includes('chicken') || n.includes('chicken')) return 'üçó';
    if (t.includes('beef') || /beef|steak/.test(n)) return 'ü•©';
    if (t.includes('lamb')) return 'üçñ';
    if (t.includes('vegetarian') || t.includes('pasta')) return 'üçù';
    if (t.includes('soup')) return 'üç≤';
    if (t.includes('lunch')) return 'ü•ó';
    return 'üçΩÔ∏è';
}
function getMealTypeEmoji(mealType) {
    return mealType === 'lunch' ? 'ü•ó' : 'üçΩÔ∏è';
}
function showToast(msg, type='default') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    document.getElementById('toast-container').appendChild(t);
    setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 300); }, 3000);
}
function showSyncIndicator(msg) {
    let i = document.querySelector('.sync-indicator');
    if (!i) { i = document.createElement('div'); i.className = 'sync-indicator'; document.body.appendChild(i); }
    i.textContent = msg; i.classList.add('visible');
    setTimeout(() => i.classList.remove('visible'), 2000);
}

// ===== NAVIGATION & MODALS =====
function initNavigation() {
    document.querySelectorAll('.nav-tab, .mobile-nav-btn').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
}
function switchView(v) {
    document.querySelectorAll('.nav-tab, .mobile-nav-btn').forEach(b => b.classList.toggle('active', b.dataset.view === v));
    document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
    document.getElementById(`${v}-view`).classList.add('active');
    if (v === 'daily') renderDailyView();
    else if (v === 'weekly') renderWeeklyView();
    else if (v === 'shopping') renderShoppingView();
    else if (v === 'recipes') renderRecipesView();
}
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function openAddRecipeModal() { 
    document.getElementById('add-recipe-form').reset(); 
    document.getElementById('import-url').value = '';
    document.getElementById('add-mealType').value = 'dinner';
    document.querySelectorAll('#add-recipe-modal .meal-type-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.meal === 'dinner');
    });
    openModal('add-recipe-modal'); 
}

// ===== MEAL TYPE TOGGLE =====
function toggleMealType(btn, formPrefix) {
    const container = btn.parentElement;
    container.querySelectorAll('.meal-type-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(`${formPrefix}-mealType`).value = btn.dataset.meal;
}

// ===== SUGGESTION TYPE TOGGLE =====
function setSuggestionType(type) {
    suggestionType = type;
    document.querySelectorAll('.suggestion-toggle-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.type === type);
    });
    renderDailyView();
}

// ===== DISCOVER NEW RECIPES =====
// Actual recipes from dairy-free/gluten-free friendly sites
const DISCOVER_RECIPES = [
    { name: 'Coconut Curry Shrimp', prepTime: 10, cookTime: 20, servings: 4, mealType: 'dinner', tags: ['dinner', 'seafood', 'thai', 'curry'], description: 'Creamy coconut curry with plump shrimp, bell peppers, and fresh basil served over rice.', sourceUrl: 'https://www.halfbakedharvest.com/coconut-curry-shrimp/' },
    { name: 'Grilled Lemon Herb Chicken', prepTime: 15, cookTime: 25, servings: 4, mealType: 'dinner', tags: ['dinner', 'chicken', 'grilled', 'mediterranean'], description: 'Juicy chicken thighs marinated in lemon, garlic, and fresh herbs.', sourceUrl: 'https://www.halfbakedharvest.com/grilled-lemon-herb-chicken/' },
    { name: 'Asian Chicken Lettuce Wraps', prepTime: 10, cookTime: 15, servings: 4, mealType: 'lunch', tags: ['lunch', 'chicken', 'asian', 'low-carb'], description: 'Savory ground chicken with water chestnuts in crisp lettuce cups.', sourceUrl: 'https://www.halfbakedharvest.com/asian-chicken-lettuce-wraps/' },
    { name: 'Chimichurri Steak with Potatoes', prepTime: 20, cookTime: 20, servings: 6, mealType: 'dinner', tags: ['dinner', 'beef', 'argentinian', 'grilled'], description: 'Perfectly grilled steak topped with vibrant herb chimichurri and crispy potatoes.', sourceUrl: 'https://www.halfbakedharvest.com/chimichurri-steak/' },
    { name: 'Thai Basil Chicken', prepTime: 10, cookTime: 15, servings: 4, mealType: 'dinner', tags: ['dinner', 'chicken', 'thai', 'quick'], description: 'Fragrant Thai basil chicken stir-fry with chilies and garlic.', sourceUrl: 'https://www.halfbakedharvest.com/thai-basil-chicken/' },
    { name: 'Mediterranean Salmon', prepTime: 15, cookTime: 15, servings: 4, mealType: 'dinner', tags: ['dinner', 'seafood', 'mediterranean', 'healthy'], description: 'Baked salmon with sun-dried tomatoes, olives, and capers.', sourceUrl: 'https://www.halfbakedharvest.com/mediterranean-salmon/' },
    { name: 'Vietnamese Caramel Pork Bowls', prepTime: 15, cookTime: 45, servings: 6, mealType: 'dinner', tags: ['dinner', 'pork', 'vietnamese', 'asian'], description: 'Tender caramelized pork over rice with fresh herbs and pickled vegetables.', sourceUrl: 'https://www.halfbakedharvest.com/vietnamese-caramel-pork/' },
    { name: 'Greek Chicken Souvlaki', prepTime: 30, cookTime: 12, servings: 4, mealType: 'dinner', tags: ['dinner', 'chicken', 'greek', 'grilled'], description: 'Marinated chicken skewers with lemon, oregano, and garlic served with tzatziki.', sourceUrl: 'https://www.halfbakedharvest.com/greek-chicken-souvlaki/' },
    { name: 'Tom Kha Gai (Coconut Chicken Soup)', prepTime: 10, cookTime: 25, servings: 6, mealType: 'lunch', tags: ['lunch', 'soup', 'thai', 'chicken'], description: 'Creamy Thai coconut soup with chicken, mushrooms, and galangal.', sourceUrl: 'https://www.halfbakedharvest.com/tom-kha-gai/' },
    { name: 'Honey Garlic Salmon', prepTime: 5, cookTime: 15, servings: 4, mealType: 'dinner', tags: ['dinner', 'seafood', 'quick', 'asian-fusion'], description: 'Quick pan-seared salmon with a sticky honey garlic glaze.', sourceUrl: 'https://www.halfbakedharvest.com/honey-garlic-salmon/' },
    { name: 'Chicken Shawarma Bowls', prepTime: 15, cookTime: 20, servings: 4, mealType: 'lunch', tags: ['lunch', 'chicken', 'mediterranean', 'healthy'], description: 'Spiced chicken shawarma over rice with hummus, vegetables, and tahini.', sourceUrl: 'https://www.halfbakedharvest.com/chicken-shawarma-bowls/' },
    { name: 'Italian Meatballs in Marinara', prepTime: 20, cookTime: 25, servings: 6, mealType: 'dinner', tags: ['dinner', 'beef', 'italian'], description: 'Tender herb meatballs simmered in homemade marinara sauce.', sourceUrl: 'https://www.halfbakedharvest.com/italian-meatballs/' },
    { name: 'Sesame Chicken Stir Fry', prepTime: 15, cookTime: 15, servings: 4, mealType: 'dinner', tags: ['dinner', 'chicken', 'asian', 'quick'], description: 'Crispy chicken in a sweet and savory sesame sauce with vegetables.', sourceUrl: 'https://www.halfbakedharvest.com/sesame-chicken/' },
    { name: 'Tuscan White Bean Soup', prepTime: 10, cookTime: 30, servings: 6, mealType: 'lunch', tags: ['lunch', 'soup', 'italian', 'vegetarian'], description: 'Hearty white bean soup with kale, tomatoes, and Italian herbs.', sourceUrl: 'https://www.halfbakedharvest.com/tuscan-white-bean-soup/' },
    { name: 'Jamaican Jerk Chicken', prepTime: 15, cookTime: 25, servings: 4, mealType: 'dinner', tags: ['dinner', 'chicken', 'caribbean', 'spicy'], description: 'Spicy jerk-seasoned grilled chicken with mango salsa.', sourceUrl: 'https://www.halfbakedharvest.com/jamaican-jerk-chicken/' }
];

function getDiscoverSuggestion() {
    // Filter out recipes we already have by name similarity
    const existingNames = appData.recipes.map(r => r.name.toLowerCase());
    const newRecipes = DISCOVER_RECIPES.filter(r => {
        const nameLower = r.name.toLowerCase();
        return !existingNames.some(existing => 
            existing.includes(nameLower) || nameLower.includes(existing) ||
            existing.split(' ').filter(w => w.length > 4).some(word => nameLower.includes(word))
        );
    });
    
    // Return a random new recipe or fallback to any discover recipe
    const pool = newRecipes.length > 0 ? newRecipes : DISCOVER_RECIPES;
    return pool[Math.floor(Math.random() * pool.length)];
}

// ===== DAILY VIEW =====
function renderDailyView() {
    document.getElementById('current-date').textContent = formatDate(new Date());
    
    const el = document.getElementById('daily-suggestion');
    
    if (suggestionType === 'discover') {
        // Show a discovery suggestion (new recipe idea)
        const disc = getDiscoverSuggestion();
        const time = (disc.prepTime||0) + (disc.cookTime||0);
        const mealBadge = `<span class="meal-type-badge ${disc.mealType || 'dinner'}">${getMealTypeEmoji(disc.mealType)} ${(disc.mealType || 'dinner').charAt(0).toUpperCase() + (disc.mealType || 'dinner').slice(1)}</span>`;
        
        el.innerHTML = `<div class="suggestion-content"><div class="suggestion-details">
            <div class="suggestion-label"><span>‚ú® Discover Something New</span></div>
            <h2 class="suggestion-recipe-name">${disc.name}</h2>
            <p class="discover-description">${disc.description}</p>
            <div class="suggestion-meta">
                ${mealBadge}
                <span class="meta-item">‚è±Ô∏è ${time} min</span>
                <span class="meta-item">üë• ${disc.servings||4}</span>
            </div>
            <div class="suggestion-tags">${(disc.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}<span class="tag dietary">Dairy-free</span><span class="tag dietary">Wheat-free</span></div>
            <a href="${disc.sourceUrl}" target="_blank" class="source-link">üîó View Full Recipe</a>
            <div class="suggestion-actions" style="margin-top:var(--space-md)">
                <button class="btn btn-primary btn-large" onclick="addDiscoverRecipe()">‚ûï Add to My Recipes</button>
                <button class="btn btn-secondary btn-large" onclick="renderDailyView();showToast('New suggestion!','success')">üîÑ Different</button>
            </div>
        </div></div>`;
        
        // Store current discover suggestion for adding
        window.currentDiscoverSuggestion = disc;
        
        // Still render favorites section
        const fg = document.getElementById('favorites-grid');
        const fav = appData.recipes.filter(r => r.favorite);
        fg.innerHTML = fav.length === 0 ? '<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">üíù</div><h3 class="empty-state-title">No favorites</h3></div>' : fav.map(renderRecipeCard).join('');
        return;
    }
    
    // From favorites that are available
    let pool = appData.recipes.filter(r => r.favorite && isRecipeAvailable(r));
    if (pool.length === 0) pool = appData.recipes.filter(r => r.favorite); // Fall back to all favorites
    const suggestionLabel = '‚ù§Ô∏è From Your Favorites';
    
    const s = pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : appData.recipes[0];
    
    if (!s) { 
        el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìñ</div><h3 class="empty-state-title">No recipes yet</h3><button class="btn btn-primary" onclick="openAddRecipeModal()">Add Recipe</button></div>'; 
        return; 
    }
    
    const time = (s.prepTime||0) + (s.cookTime||0);
    const img = s.imageUrl ? `<img src="${s.imageUrl}" class="suggestion-image" onerror="this.style.display='none'">` : '';
    const mealBadge = `<span class="meal-type-badge ${s.mealType || 'dinner'}">${getMealTypeEmoji(s.mealType)} ${(s.mealType || 'dinner').charAt(0).toUpperCase() + (s.mealType || 'dinner').slice(1)}</span>`;
    
    el.innerHTML = `<div class="suggestion-content">${img}<div class="suggestion-details">
        <div class="suggestion-label"><span>${suggestionLabel}</span></div>
        <h2 class="suggestion-recipe-name">${s.name}</h2>
        <div class="suggestion-meta">
            ${mealBadge}
            <span class="meta-item">‚è±Ô∏è ${time} min</span>
            <span class="meta-item">üë• ${s.servings||4}</span>
            ${s.lastCooked?`<span class="meta-item">üìÖ ${getDaysSinceCooked(s)} days ago</span>`:''}
        </div>
        <div class="suggestion-tags">${(s.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}<span class="tag dietary">Dairy-free</span><span class="tag dietary">Wheat-free</span></div>
        ${s.sourceUrl?`<a href="${s.sourceUrl}" target="_blank" class="source-link" onclick="event.stopPropagation()">üîó View Original Recipe</a>`:''}
        <div class="suggestion-actions" style="margin-top:var(--space-md)">
            <button class="btn btn-primary btn-large" onclick="cookRecipe('${s.id}')">üç≥ Cook This</button>
            <button class="btn btn-secondary btn-large" onclick="viewRecipeDetail('${s.id}')">View Recipe</button>
            <button class="btn btn-secondary btn-large" onclick="renderDailyView();showToast('New suggestion!','success')">üîÑ Different</button>
        </div>
    </div></div>`;
    
    const fg = document.getElementById('favorites-grid');
    const fav = appData.recipes.filter(r => r.favorite);
    fg.innerHTML = fav.length === 0 ? '<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">üíù</div><h3 class="empty-state-title">No favorites</h3></div>' : fav.map(renderRecipeCard).join('');
}

async function cookRecipe(id) {
    const r = appData.recipes.find(x => x.id === id);
    if (r) { 
        r.lastCooked = new Date().toISOString(); 
        await FirebaseDB.updateRecipe(id, { lastCooked: r.lastCooked }); 
        showToast(`Marked "${r.name}" as cooked!`, 'success'); 
        showSyncIndicator('Synced ‚úì'); 
        renderDailyView(); 
    }
}

// Add a discovered recipe to the collection
async function addDiscoverRecipe() {
    const disc = window.currentDiscoverSuggestion;
    if (!disc) return;
    
    const recipe = {
        name: disc.name,
        prepTime: disc.prepTime || 0,
        cookTime: disc.cookTime || 0,
        servings: disc.servings || 4,
        mealType: disc.mealType || 'dinner',
        ingredients: [],
        instructions: [],
        tags: disc.tags || [],
        sourceUrl: disc.sourceUrl || '',
        imageUrl: '',
        favorite: false,
        lastCooked: null
    };
    
    const newRecipe = await FirebaseDB.addRecipe(recipe);
    appData.recipes.push(newRecipe);
    showToast(`Added "${recipe.name}" to your recipes!`, 'success');
    showSyncIndicator('Synced ‚úì');
    renderDailyView();
    renderRecipesView();
}

// Search for a recipe online
function searchForRecipe(name) {
    const query = encodeURIComponent(`${name} recipe dairy free gluten free`);
    window.open(`https://www.google.com/search?q=${query}`, '_blank');
}

// ===== WEEKLY VIEW (with Lunch/Dinner) =====
function renderWeeklyView() {
    const today = new Date(), start = new Date(today);
    start.setDate(today.getDate() - today.getDay() + currentWeekOffset * 7);
    const end = new Date(start); end.setDate(start.getDate() + 6);
    document.getElementById('week-title').textContent = currentWeekOffset === 0 ? 'This Week' : `${start.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${end.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
    
    const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    document.getElementById('week-grid').innerHTML = days.map((d,i) => {
        const date = new Date(start); date.setDate(start.getDate() + i);
        const dk = date.toISOString().split('T')[0], isToday = date.toDateString() === today.toDateString();
        const dayPlan = appData.weeklyPlan[dk] || { lunch: [], dinner: [] };
        
        // Handle old format (array) vs new format (object with lunch/dinner)
        let lunch = [], dinner = [];
        if (Array.isArray(dayPlan)) {
            // Old format - treat all as dinner
            dinner = dayPlan;
        } else {
            lunch = dayPlan.lunch || [];
            dinner = dayPlan.dinner || [];
        }
        
        return `<div class="day-card ${isToday?'today':''}">
            <div class="day-header">
                <div class="day-name">${d}</div>
                <div class="day-date">${date.getDate()}</div>
            </div>
            <div class="day-content">
                <div class="meal-slot">
                    <div class="meal-slot-header">ü•ó Lunch</div>
                    ${lunch.map(rid => {
                        const r = appData.recipes.find(x => x.id === rid);
                        return r ? `<div class="day-meal" onclick="viewRecipeDetail('${r.id}')">
                            <span class="day-meal-name">${r.name}</span>
                            <button class="day-meal-remove" onclick="event.stopPropagation();removeMealFromDay('${dk}','${r.id}','lunch')">‚úï</button>
                        </div>` : '';
                    }).join('')}
                    <button class="day-add-btn" onclick="openRecipeSelector('${dk}', 'lunch')">+ Add Lunch</button>
                </div>
                <div class="meal-slot">
                    <div class="meal-slot-header">üçΩÔ∏è Dinner</div>
                    ${dinner.map(rid => {
                        const r = appData.recipes.find(x => x.id === rid);
                        return r ? `<div class="day-meal" onclick="viewRecipeDetail('${r.id}')">
                            <span class="day-meal-name">${r.name}</span>
                            <button class="day-meal-remove" onclick="event.stopPropagation();removeMealFromDay('${dk}','${r.id}','dinner')">‚úï</button>
                        </div>` : '';
                    }).join('')}
                    <button class="day-add-btn" onclick="openRecipeSelector('${dk}', 'dinner')">+ Add Dinner</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function changeWeek(o) { currentWeekOffset += o; renderWeeklyView(); }

async function generateWeeklyPlan() {
    const today = new Date(), start = new Date(today);
    start.setDate(today.getDate() - today.getDay() + currentWeekOffset * 7);
    
    const lunchRecipes = appData.recipes.filter(r => isRecipeAvailable(r) && (r.mealType === 'lunch' || r.tags?.includes('lunch')));
    const dinnerRecipes = appData.recipes.filter(r => isRecipeAvailable(r) && (r.mealType === 'dinner' || r.mealType === undefined || r.tags?.includes('dinner')));
    
    const shuffledLunch = [...lunchRecipes].sort(() => Math.random() - 0.5);
    const shuffledDinner = [...dinnerRecipes].sort(() => Math.random() - 0.5);
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(start); date.setDate(start.getDate() + i);
        const dk = date.toISOString().split('T')[0];
        
        if (!appData.weeklyPlan[dk]) {
            appData.weeklyPlan[dk] = { lunch: [], dinner: [] };
        } else if (Array.isArray(appData.weeklyPlan[dk])) {
            // Convert old format
            appData.weeklyPlan[dk] = { lunch: [], dinner: appData.weeklyPlan[dk] };
        }
        
        if (appData.weeklyPlan[dk].lunch.length === 0 && shuffledLunch[i % Math.max(shuffledLunch.length, 1)]) {
            appData.weeklyPlan[dk].lunch = [shuffledLunch[i % shuffledLunch.length].id];
        }
        if (appData.weeklyPlan[dk].dinner.length === 0 && shuffledDinner[i % Math.max(shuffledDinner.length, 1)]) {
            appData.weeklyPlan[dk].dinner = [shuffledDinner[i % shuffledDinner.length].id];
        }
    }
    
    await FirebaseDB.saveWeeklyPlan(appData.weeklyPlan);
    showToast('Week plan generated!', 'success'); 
    showSyncIndicator('Synced ‚úì'); 
    renderWeeklyView();
}

function openRecipeSelector(dk, mealSlot) { 
    selectedDayForRecipe = dk; 
    selectedMealSlot = mealSlot;
    document.getElementById('select-recipe-title').textContent = `Select ${mealSlot.charAt(0).toUpperCase() + mealSlot.slice(1)} Recipe`;
    renderRecipeSelector(); 
    openModal('select-recipe-modal'); 
}

function renderRecipeSelector() {
    const search = document.getElementById('recipe-selector-search')?.value?.toLowerCase() || '';
    
    // Get currently selected recipes for this day
    const dayPlan = appData.weeklyPlan[selectedDayForRecipe] || { lunch: [], dinner: [] };
    const currentMealRecipes = Array.isArray(dayPlan) ? dayPlan : (dayPlan[selectedMealSlot] || []);
    
    // Don't filter by meal type anymore - show all recipes and let user decide
    let recipes = appData.recipes.filter(r => r.name.toLowerCase().includes(search));
    
    // Sort: meal-type matching recipes first, then others
    recipes.sort((a, b) => {
        const aMatches = (selectedMealSlot === 'lunch' && (a.mealType === 'lunch' || a.tags?.includes('lunch'))) ||
                        (selectedMealSlot === 'dinner' && (a.mealType === 'dinner' || a.mealType === undefined));
        const bMatches = (selectedMealSlot === 'lunch' && (b.mealType === 'lunch' || b.tags?.includes('lunch'))) ||
                        (selectedMealSlot === 'dinner' && (b.mealType === 'dinner' || b.mealType === undefined));
        if (aMatches && !bMatches) return -1;
        if (!aMatches && bMatches) return 1;
        return 0;
    });
    
    document.getElementById('recipe-selector').innerHTML = recipes.map(r => {
        const avail = isRecipeAvailable(r), days = getDaysSinceCooked(r);
        const alreadySelected = currentMealRecipes.includes(r.id);
        const thumb = r.imageUrl ? `<img src="${r.imageUrl}" class="recipe-selector-thumb" onerror="this.outerHTML='<div class=recipe-selector-thumb style=display:flex;align-items:center;justify-content:center>${getRecipeEmoji(r)}</div>'">` : `<div class="recipe-selector-thumb" style="display:flex;align-items:center;justify-content:center;font-size:1.5rem">${getRecipeEmoji(r)}</div>`;
        const mealTypeBadge = `<span class="selector-meal-badge ${r.mealType || 'dinner'}">${getMealTypeEmoji(r.mealType)}</span>`;
        
        return `<div class="recipe-selector-item ${avail?'':'unavailable'} ${alreadySelected?'already-selected':''}" onclick="${avail && !alreadySelected?`selectRecipeForDay('${r.id}')`:''}">
            ${thumb}
            <div class="recipe-selector-info">
                <div class="recipe-selector-name">${mealTypeBadge} ${r.name}</div>
                <div class="recipe-selector-meta">
                    ${alreadySelected ? '‚úì Already added' : (avail?'‚úÖ Available':`‚è≥ ${ROTATION_DAYS-days}d`)}
                    ‚Ä¢ ${(r.prepTime||0)+(r.cookTime||0)} min
                </div>
            </div>
        </div>`;
    }).join('');
}

function filterRecipeSelector() { renderRecipeSelector(); }

async function selectRecipeForDay(rid) {
    const dk = selectedDayForRecipe;
    const slot = selectedMealSlot;
    
    if (!appData.weeklyPlan[dk]) {
        appData.weeklyPlan[dk] = { lunch: [], dinner: [] };
    } else if (Array.isArray(appData.weeklyPlan[dk])) {
        appData.weeklyPlan[dk] = { lunch: [], dinner: appData.weeklyPlan[dk] };
    }
    
    appData.weeklyPlan[dk][slot].push(rid);
    await FirebaseDB.saveWeeklyPlan(appData.weeklyPlan);
    showToast('Added!', 'success'); 
    showSyncIndicator('Synced ‚úì'); 
    closeModal('select-recipe-modal'); 
    renderWeeklyView();
}

async function removeMealFromDay(dk, rid, slot) {
    if (appData.weeklyPlan[dk]) {
        if (Array.isArray(appData.weeklyPlan[dk])) {
            appData.weeklyPlan[dk] = appData.weeklyPlan[dk].filter(id => id !== rid);
        } else {
            appData.weeklyPlan[dk][slot] = appData.weeklyPlan[dk][slot].filter(id => id !== rid);
        }
        await FirebaseDB.saveWeeklyPlan(appData.weeklyPlan); 
        showSyncIndicator('Synced ‚úì'); 
        renderWeeklyView();
    }
}

// ===== SHOPPING VIEW =====
function renderShoppingView() {
    const cats = generateShoppingList(), container = document.getElementById('shopping-categories');
    const cfg = { produce:{icon:'ü•¨',name:'Produce'}, protein:{icon:'ü•©',name:'Protein'}, dairy:{icon:'üßÄ',name:'Dairy Alt'}, pantry:{icon:'ü´ô',name:'Pantry'}, spices:{icon:'üåø',name:'Spices'}, other:{icon:'üì¶',name:'Other'} };
    
    if (!Object.keys(cats).length) { 
        container.innerHTML = `
            <div class="empty-state" style="grid-column:1/-1">
                <div class="empty-state-icon">üõí</div>
                <h3 class="empty-state-title">Shopping list is empty</h3>
                <p>Add meals to your weekly plan to generate a shopping list.</p>
                <button class="btn btn-primary" onclick="switchView('weekly')">Plan Your Week</button>
            </div>
            <div class="pantry-stock-section" style="grid-column:1/-1; margin-top: 2rem;">
                <div class="shopping-section-header">
                    <h2>üè† Pantry Stock</h2>
                    <button class="btn btn-small btn-secondary" onclick="openStockManager()">‚öôÔ∏è Manage</button>
                </div>
                <p class="stock-description">Items you always have on hand won't appear in your shopping list.</p>
                <div class="stock-items-display">${renderStockItemsPreview()}</div>
            </div>
        `; 
        return; 
    }
    
    // Filter out items that are in pantry stock
    const stockItems = appData.pantryStock || [];
    
    // Build all items list, excluding stock items
    const allItems = Object.values(cats).flat().filter(item => {
        const itemLower = item.name.toLowerCase();
        return !stockItems.some(stock => {
            const stockName = (typeof stock === 'string' ? stock : stock.name).toLowerCase();
            return itemLower.includes(stockName) || stockName.includes(itemLower);
        });
    });
    
    const needToBuy = allItems.filter(item => !appData.checkedItems.includes(item.id));
    const inCart = allItems.filter(item => appData.checkedItems.includes(item.id));
    
    let html = '';
    
    // NEED TO BUY section
    html += `<div class="shopping-section need-to-buy">
        <div class="shopping-section-header">
            <h2>üõí Need to Buy (${needToBuy.length})</h2>
            <button class="btn btn-small btn-secondary" onclick="clearAllShoppingItems()">Clear All</button>
        </div>`;
    
    if (needToBuy.length === 0 && inCart.length === 0) {
        html += `<div class="shopping-complete">
            <div class="complete-icon">üéâ</div>
            <p>All done! You have everything.</p>
        </div>`;
    } else if (needToBuy.length === 0) {
        html += `<div class="shopping-complete">
            <div class="complete-icon">‚úÖ</div>
            <p>All items are in your cart!</p>
        </div>`;
    } else {
        // Group by category
        const needByCategory = {};
        needToBuy.forEach(item => {
            if (!needByCategory[item.category]) needByCategory[item.category] = [];
            needByCategory[item.category].push(item);
        });
        
        html += '<div class="shopping-items-grid">';
        Object.entries(needByCategory).forEach(([cat, items]) => {
            const c = cfg[cat] || cfg.other;
            html += `<div class="shopping-category">
                <div class="category-label">${c.icon} ${c.name}</div>
                <div class="category-items-list">
                    ${items.map(item => `
                        <div class="shopping-item" onclick="markAsPurchased('${item.id}')">
                            <span class="item-checkbox">‚óã</span>
                            <span class="item-text">${item.name}</span>
                            <button class="add-to-stock-btn" onclick="event.stopPropagation();addToStock('${item.name.replace(/'/g, "\\'")}')">üìå</button>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        });
        html += '</div>';
    }
    html += '</div>';
    
    // IN CART section
    if (inCart.length > 0) {
        html += `<div class="shopping-section in-cart">
            <div class="shopping-section-header">
                <h2>‚úÖ In Cart (${inCart.length})</h2>
                <button class="btn btn-small btn-secondary" onclick="clearCheckedItems()">Clear Cart</button>
            </div>
            <div class="cart-items">
                ${inCart.map(item => `
                    <div class="cart-item" onclick="markAsNeeded('${item.id}')">
                        <span class="item-check">‚úì</span>
                        <span class="item-text">${item.name}</span>
                    </div>
                `).join('')}
            </div>
        </div>`;
    }
    
    // PANTRY STOCK section
    html += `<div class="pantry-stock-section">
        <div class="shopping-section-header">
            <h2>üè† Pantry Stock (${stockItems.length})</h2>
            <button class="btn btn-small btn-secondary" onclick="openStockManager()">‚öôÔ∏è Manage</button>
        </div>
        <p class="stock-description">Items you always have on hand. They won't appear in your shopping list.</p>
        <div class="stock-items-display">${renderStockItemsPreview()}</div>
    </div>`;
    
    container.innerHTML = html;
}

function renderStockItemsPreview() {
    const stockItems = appData.pantryStock || [];
    if (stockItems.length === 0) {
        return '<p class="no-stock">No stock items yet. Click üìå on any shopping item to add it to your pantry stock.</p>';
    }
    return stockItems.slice(0, 10).map(item => {
        const name = typeof item === 'string' ? item : item.name;
        return `<span class="stock-tag">${name}</span>`;
    }).join('') + 
           (stockItems.length > 10 ? `<span class="stock-more">+${stockItems.length - 10} more</span>` : '');
}

async function addToStock(itemName) {
    // Extract the main ingredient name (remove quantities)
    const cleanName = itemName.replace(/^[\d\s\/\.\-]+/, '').replace(/^\s*(cup|tablespoon|teaspoon|tbsp|tsp|lb|pound|oz|ounce|can|clove|inch)s?\s+/i, '').trim();
    const stockName = cleanName.split(',')[0].trim(); // Take first part before comma
    
    if (!appData.pantryStock) appData.pantryStock = [];
    if (!appData.pantryStock.includes(stockName)) {
        appData.pantryStock.push(stockName);
        await FirebaseDB.saveSettings({ pantryStock: appData.pantryStock, checkedItems: appData.checkedItems });
        showToast(`Added "${stockName}" to pantry stock`, 'success');
        renderShoppingView();
    } else {
        showToast(`"${stockName}" is already in pantry stock`, 'default');
    }
}

async function removeFromStock(itemName) {
    if (!appData.pantryStock) return;
    appData.pantryStock = appData.pantryStock.filter(i => {
        const name = typeof i === 'string' ? i : i.name;
        return name !== itemName;
    });
    await FirebaseDB.saveSettings({ pantryStock: appData.pantryStock, checkedItems: appData.checkedItems });
    showToast(`Removed "${itemName}" from pantry stock`, 'success');
    renderShoppingView();
    // Also update modal if open
    const modal = document.getElementById('stock-manager-modal');
    if (modal && modal.classList.contains('active')) {
        renderStockManagerContent();
    }
}

function openStockManager() {
    renderStockManagerContent();
    openModal('stock-manager-modal');
}

function renderStockManagerContent() {
    const stockItems = appData.pantryStock || [];
    const content = document.getElementById('stock-manager-content');
    
    content.innerHTML = `
        <div class="stock-manager-tabs">
            <button class="stock-tab active" onclick="showStockTab('manual')">‚úèÔ∏è Add Manually</button>
            <button class="stock-tab" onclick="showStockTab('photo')">üì∑ Scan Item</button>
        </div>
        
        <div id="stock-tab-manual" class="stock-tab-content active">
            <div class="stock-manager-add">
                <input type="text" class="form-input" id="new-stock-item" placeholder="Add item (e.g., olive oil, garlic, salt)" onkeypress="if(event.key==='Enter')addNewStockItem()">
                <button class="btn btn-primary" onclick="addNewStockItem()">Add</button>
            </div>
        </div>
        
        <div id="stock-tab-photo" class="stock-tab-content">
            <div class="photo-capture-section">
                <p class="photo-instructions">Take a photo of a pantry item to automatically add it to your stock.</p>
                <div class="photo-buttons">
                    <label class="btn btn-primary photo-upload-btn">
                        üì∑ Take Photo
                        <input type="file" accept="image/*" capture="environment" onchange="handleStockPhoto(this)" style="display:none">
                    </label>
                    <label class="btn btn-secondary photo-upload-btn">
                        üñºÔ∏è Choose Photo
                        <input type="file" accept="image/*" onchange="handleStockPhoto(this)" style="display:none">
                    </label>
                </div>
                <div id="photo-preview-container"></div>
                <div id="photo-analysis-result"></div>
            </div>
        </div>
        
        <div class="stock-manager-list-header">
            <h4>Your Pantry Stock (${stockItems.length} items)</h4>
        </div>
        <div class="stock-manager-list">
            ${stockItems.length === 0 ? '<p class="no-stock">No pantry stock items yet.</p>' : 
            stockItems.map(item => {
                const isObject = typeof item === 'object';
                const name = isObject ? item.name : item;
                const photo = isObject ? item.photo : null;
                const details = isObject ? item.details : null;
                
                return `
                <div class="stock-manager-item ${photo ? 'has-photo' : ''}">
                    ${photo ? `<img src="${photo}" class="stock-item-photo" onclick="viewStockItemPhoto('${name.replace(/'/g, "\\'")}')">` : '<div class="stock-item-no-photo">üì¶</div>'}
                    <div class="stock-item-info">
                        <span class="stock-item-name">${name}</span>
                        ${details ? `<span class="stock-item-details">${details}</span>` : ''}
                    </div>
                    <button class="btn btn-small btn-danger" onclick="removeFromStock('${name.replace(/'/g, "\\'")}')">‚úï</button>
                </div>`;
            }).join('')}
        </div>
    `;
}

function showStockTab(tab) {
    document.querySelectorAll('.stock-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.stock-tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.stock-tab[onclick*="${tab}"]`).classList.add('active');
    document.getElementById(`stock-tab-${tab}`).classList.add('active');
}

async function handleStockPhoto(input) {
    const file = input.files[0];
    if (!file) return;
    
    const previewContainer = document.getElementById('photo-preview-container');
    const resultContainer = document.getElementById('photo-analysis-result');
    
    // Show preview
    const reader = new FileReader();
    reader.onload = async (e) => {
        const imageData = e.target.result;
        // Store in a module-level variable instead of passing through onclick
        pendingPhotoData = imageData;
        previewContainer.innerHTML = `<img src="${imageData}" class="photo-preview">`;
        resultContainer.innerHTML = `<div class="analyzing-message"><div class="loading-spinner-small"></div> Analyzing image...</div>`;
        
        setTimeout(() => {
            resultContainer.innerHTML = `
                <div class="photo-result-form">
                    <p>What item is this?</p>
                    <input type="text" class="form-input" id="photo-item-name" placeholder="e.g., Extra Virgin Olive Oil">
                    <input type="text" class="form-input" id="photo-item-details" placeholder="Brand, size, notes (optional)" style="margin-top:0.5rem">
                    <button class="btn btn-primary" onclick="savePhotoStockItem()">Add to Stock</button>
                </div>
            `;
        }, 500);
    };
    reader.readAsDataURL(file);
}

async function savePhotoStockItem() {
    const imageData = pendingPhotoData;
    if (!imageData) {
        showToast('No photo data available. Please take a photo first.', 'error');
        return;
    }
    
    const name = document.getElementById('photo-item-name').value.trim();
    const details = document.getElementById('photo-item-details').value.trim();
    
    if (!name) {
        showToast('Please enter an item name', 'error');
        return;
    }
    
    if (!appData.pantryStock) appData.pantryStock = [];
    
    // Check if already exists
    const existingIndex = appData.pantryStock.findIndex(item => 
        (typeof item === 'string' ? item : item.name).toLowerCase() === name.toLowerCase()
    );
    
    const stockItem = {
        name: name,
        photo: imageData,
        details: details || null,
        addedAt: new Date().toISOString()
    };
    
    if (existingIndex >= 0) {
        appData.pantryStock[existingIndex] = stockItem;
        showToast(`Updated "${name}" in pantry stock`, 'success');
    } else {
        appData.pantryStock.push(stockItem);
        showToast(`Added "${name}" to pantry stock`, 'success');
    }
    
    await FirebaseDB.saveSettings({ pantryStock: appData.pantryStock, checkedItems: appData.checkedItems });
    renderStockManagerContent();
    renderShoppingView();
}

function viewStockItemPhoto(itemName) {
    const item = appData.pantryStock.find(i => (typeof i === 'string' ? i : i.name) === itemName);
    if (item && typeof item === 'object' && item.photo) {
        // Create a simple lightbox
        const lightbox = document.createElement('div');
        lightbox.className = 'photo-lightbox';
        lightbox.innerHTML = `
            <div class="lightbox-content">
                <img src="${item.photo}" alt="${item.name}">
                <div class="lightbox-info">
                    <h3>${item.name}</h3>
                    ${item.details ? `<p>${item.details}</p>` : ''}
                </div>
                <button class="lightbox-close" onclick="this.parentElement.parentElement.remove()">‚úï</button>
            </div>
        `;
        lightbox.onclick = (e) => { if (e.target === lightbox) lightbox.remove(); };
        document.body.appendChild(lightbox);
    }
}

async function addNewStockItem() {
    const input = document.getElementById('new-stock-item');
    const value = input.value.trim();
    if (!value) return;
    
    if (!appData.pantryStock) appData.pantryStock = [];
    if (!appData.pantryStock.includes(value)) {
        appData.pantryStock.push(value);
        await FirebaseDB.saveSettings({ pantryStock: appData.pantryStock, checkedItems: appData.checkedItems });
        showToast(`Added "${value}" to pantry stock`, 'success');
        input.value = '';
        renderStockManagerContent();
        renderShoppingView();
    } else {
        showToast(`"${value}" is already in pantry stock`, 'default');
    }
}

async function clearAllShoppingItems() {
    if (!confirm('This will remove all meals from your weekly plan, clearing the shopping list. Continue?')) return;
    
    // Clear the current week's plan
    const today = new Date();
    const start = new Date(today);
    start.setDate(today.getDate() - today.getDay());
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(start);
        date.setDate(start.getDate() + i);
        const dk = date.toISOString().split('T')[0];
        delete appData.weeklyPlan[dk];
    }
    
    appData.checkedItems = [];
    await Promise.all([
        FirebaseDB.saveWeeklyPlan(appData.weeklyPlan),
        FirebaseDB.saveSettings({ checkedItems: [], pantryStock: appData.pantryStock || [] })
    ]);
    
    showToast('Weekly plan and shopping list cleared', 'success');
    showSyncIndicator('Synced ‚úì');
    renderShoppingView();
    renderWeeklyView();
}

function generateShoppingList() {
    const ings = {}, cats = {};
    Object.values(appData.weeklyPlan).forEach(dayPlan => {
        let meals = [];
        if (Array.isArray(dayPlan)) {
            meals = dayPlan;
        } else {
            meals = [...(dayPlan.lunch || []), ...(dayPlan.dinner || [])];
        }
        meals.forEach(rid => {
            const r = appData.recipes.find(x => x.id === rid);
            r?.ingredients?.forEach(ing => { 
                // Clean the ingredient text before displaying
                const cleanedIng = cleanIngredientText(ing);
                if (!cleanedIng) return; // Skip empty lines
                
                // Create a stable ID based on the cleaned ingredient text
                const cleanName = cleanedIng.toLowerCase().trim();
                const stableId = 'ing_' + cleanName.replace(/[^a-z0-9]/g, '_').substring(0, 50);
                if (!ings[cleanName]) {
                    ings[cleanName] = { id: stableId, name: cleanedIng, category: categorize(cleanedIng) }; 
                }
            });
        });
    });
    Object.values(ings).forEach(i => { if (!cats[i.category]) cats[i.category] = []; cats[i.category].push(i); });
    return cats;
}

// Clean ingredient text - removes checkboxes, bullets, and other artifacts
function cleanIngredientText(text) {
    if (!text) return '';
    return text
        // Remove checkbox characters (empty and checked variants)
        .replace(/[\u2610\u2611\u2612\u2713\u2714\u2715\u2716\u2717\u2718]/g, '')
        .replace(/[‚òê‚òë‚òí‚úì‚úî‚úï‚úñ‚úó‚úò‚ñ¢‚ñ£‚óª‚óº‚óΩ‚óæ]/g, '')
        .replace(/[\uFE0F]/g, '') // Remove emoji variation selectors
        // Remove box drawing characters that might look like checkboxes
        .replace(/[‚ñ°‚ñ†‚óØ‚óè‚óã‚óé]/g, '')
        // Remove common bullet points
        .replace(/^[\s‚Ä¢\-\*\>\|\u2022\u2023\u2043\u204C\u204D\u2219\u25AA\u25AB\u25CF\u25CB\u25D8\u25D9]+/g, '')
        // Remove numbered list prefixes
        .replace(/^\d+[\.\)]\s*/g, '')
        // Remove lettered list prefixes
        .replace(/^[a-zA-Z][\.\)]\s*/g, '')
        // Normalize whitespace
        .replace(/\s+/g, ' ')
        .trim();
}

function categorize(i) {
    const l = i.toLowerCase();
    if (/chicken|beef|lamb|pork|fish|salmon|shrimp|cod|turkey|steak/.test(l)) return 'protein';
    if (/goat|coconut cream|coconut milk|ghee/.test(l)) return 'dairy';
    if (/spinach|lettuce|zucchini|tomato|onion|garlic|pepper|potato|carrot|celery|basil|parsley|cilantro|mint|dill|lime|lemon|ginger|cucumber|mango|avocado|jalapen|serrano|poblano|bell pepper|green onion|scallion/.test(l)) return 'produce';
    if (/cumin|coriander|turmeric|paprika|cinnamon|oregano|thyme|rosemary|salt|pepper|chili powder|gochujang|sesame/.test(l)) return 'spices';
    if (/flour|oil|honey|vinegar|sauce|sugar|broth|aminos|tapioca|rice|tortilla|worcestershire/.test(l)) return 'pantry';
    return 'other';
}

async function markAsPurchased(id) {
    if (!appData.checkedItems.includes(id)) {
        appData.checkedItems.push(id);
        await FirebaseDB.saveSettings({ checkedItems: appData.checkedItems, pantryStock: appData.pantryStock || [] });
        renderShoppingView();
    }
}

async function markAsNeeded(id) {
    const idx = appData.checkedItems.indexOf(id);
    if (idx > -1) {
        appData.checkedItems.splice(idx, 1);
        await FirebaseDB.saveSettings({ checkedItems: appData.checkedItems, pantryStock: appData.pantryStock || [] });
        renderShoppingView();
    }
}

async function toggleShoppingItem(id) {
    const idx = appData.checkedItems.indexOf(id);
    if (idx > -1) appData.checkedItems.splice(idx, 1); else appData.checkedItems.push(id);
    await FirebaseDB.saveSettings({ checkedItems: appData.checkedItems }); renderShoppingView();
}
async function clearCheckedItems() { appData.checkedItems = []; await FirebaseDB.saveSettings({ checkedItems: [], pantryStock: appData.pantryStock || [] }); showToast('Cart cleared', 'success'); renderShoppingView(); }
async function regenerateShoppingList() { appData.checkedItems = []; await FirebaseDB.saveSettings({ checkedItems: [], pantryStock: appData.pantryStock || [] }); showToast('List regenerated!', 'success'); renderShoppingView(); }

// Clean all recipes - removes checkbox characters from existing recipes
async function cleanAllRecipes() {
    if (!confirm('This will clean checkbox characters and other formatting artifacts from all your recipes. Continue?')) return;
    
    let cleanedCount = 0;
    
    for (const recipe of appData.recipes) {
        let needsUpdate = false;
        
        // Clean ingredients
        if (recipe.ingredients && recipe.ingredients.length > 0) {
            const cleanedIngredients = recipe.ingredients
                .map(ing => cleanIngredientText(ing))
                .filter(ing => ing); // Remove empty strings
            
            if (JSON.stringify(cleanedIngredients) !== JSON.stringify(recipe.ingredients)) {
                recipe.ingredients = cleanedIngredients;
                needsUpdate = true;
            }
        }
        
        // Clean instructions too
        if (recipe.instructions && recipe.instructions.length > 0) {
            const cleanedInstructions = recipe.instructions
                .map(inst => cleanIngredientText(inst))
                .filter(inst => inst);
            
            if (JSON.stringify(cleanedInstructions) !== JSON.stringify(recipe.instructions)) {
                recipe.instructions = cleanedInstructions;
                needsUpdate = true;
            }
        }
        
        if (needsUpdate) {
            await FirebaseDB.updateRecipe(recipe.id, { 
                ingredients: recipe.ingredients,
                instructions: recipe.instructions 
            });
            cleanedCount++;
        }
    }
    
    showToast(`Cleaned ${cleanedCount} recipe${cleanedCount !== 1 ? 's' : ''}!`, 'success');
    showSyncIndicator('Synced ‚úì');
    renderRecipesView();
    renderShoppingView();
}

// ===== RECIPES VIEW =====
function renderRecipesView() { updateStats(); renderAllRecipes(); initFilterChips(); }
function updateStats() {
    document.getElementById('stat-total').textContent = appData.recipes.length;
    document.getElementById('stat-available').textContent = appData.recipes.filter(isRecipeAvailable).length;
    document.getElementById('stat-favorites').textContent = appData.recipes.filter(r => r.favorite).length;
}
function renderAllRecipes() {
    const grid = document.getElementById('all-recipes-grid'), search = document.getElementById('recipe-search')?.value?.toLowerCase() || '';
    let filtered = appData.recipes.filter(r => r.name.toLowerCase().includes(search) || (r.tags||[]).some(t => t.toLowerCase().includes(search)));
    if (currentFilter === 'available') filtered = filtered.filter(isRecipeAvailable);
    else if (currentFilter === 'favorites') filtered = filtered.filter(r => r.favorite);
    else if (currentFilter === 'lunch') filtered = filtered.filter(r => r.mealType === 'lunch' || (r.tags||[]).includes('lunch'));
    else if (currentFilter === 'dinner') filtered = filtered.filter(r => r.mealType === 'dinner' || r.mealType === undefined || (r.tags||[]).includes('dinner'));
    else if (currentFilter === 'quick') filtered = filtered.filter(r => (r.prepTime||0)+(r.cookTime||0) <= 30);
    grid.innerHTML = filtered.length === 0 ? '<div class="empty-state" style="grid-column:1/-1"><div class="empty-state-icon">üìñ</div><h3 class="empty-state-title">No recipes</h3></div>' : filtered.map(renderRecipeCard).join('');
}

function renderRecipeCard(r) {
    const avail = isRecipeAvailable(r), days = getDaysSinceCooked(r), time = (r.prepTime||0)+(r.cookTime||0);
    const img = r.imageUrl ? `<img src="${r.imageUrl}" class="recipe-card-image" onerror="this.outerHTML='<div class=recipe-card-image-placeholder>${getRecipeEmoji(r)}</div>'">` : `<div class="recipe-card-image-placeholder">${getRecipeEmoji(r)}</div>`;
    const mealBadge = `<div class="card-meal-badge ${r.mealType || 'dinner'}">${getMealTypeEmoji(r.mealType)}</div>`;
    return `<div class="recipe-card" onclick="viewRecipeDetail('${r.id}')">
        ${!avail?`<div class="rotation-badge">${ROTATION_DAYS-days}d</div>`:r.lastCooked?'<div class="rotation-badge available">Ready</div>':''}
        ${mealBadge}
        ${img}
        <div class="recipe-card-body">
            <div class="recipe-card-header">
                <h3 class="recipe-card-name">${r.name}</h3>
                <button class="favorite-btn ${r.favorite?'favorited':''}" onclick="event.stopPropagation();toggleFavorite('${r.id}')">${r.favorite?'‚ù§Ô∏è':'ü§ç'}</button>
            </div>
            <div class="recipe-card-meta"><span>‚è±Ô∏è ${time}m</span><span>üë• ${r.servings||4}</span></div>
            <div class="recipe-card-tags">${(r.tags||[]).slice(0,3).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
        </div>
    </div>`;
}

function initFilterChips() {
    document.querySelectorAll('.filter-chip').forEach(chip => chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active'); currentFilter = chip.dataset.filter; renderAllRecipes();
    }));
}
function filterRecipes() { renderAllRecipes(); }

async function toggleFavorite(id) {
    const r = appData.recipes.find(x => x.id === id);
    if (r) { r.favorite = !r.favorite; await FirebaseDB.updateRecipe(id, { favorite: r.favorite }); showToast(r.favorite ? 'Added to favorites' : 'Removed', 'success'); showSyncIndicator('Synced ‚úì'); renderAllRecipes(); renderDailyView(); }
}

// ===== RECIPE DETAIL =====
let currentRecipeMultiplier = 1;

function viewRecipeDetail(id) {
    const r = appData.recipes.find(x => x.id === id);
    if (!r) return;
    currentRecipeMultiplier = 1; // Reset multiplier
    renderRecipeDetailContent(r);
    openModal('recipe-detail-modal');
}

function renderRecipeDetailContent(r, multiplier = 1) {
    const time = (r.prepTime||0)+(r.cookTime||0);
    const img = r.imageUrl ? `<img src="${r.imageUrl}" class="recipe-detail-image" onerror="this.style.display='none'">` : '';
    const mealBadge = `<span class="meal-type-badge ${r.mealType || 'dinner'}">${getMealTypeEmoji(r.mealType)} ${(r.mealType || 'dinner').charAt(0).toUpperCase() + (r.mealType || 'dinner').slice(1)}</span>`;
    const baseServings = r.servings || 4;
    const adjustedServings = baseServings * multiplier;
    
    const hasIngredients = r.ingredients && r.ingredients.length > 0;
    const hasInstructions = r.instructions && r.instructions.length > 0;
    
    let content = `${img}
        <div class="recipe-detail-header">
            <h2 class="recipe-detail-name">${r.name}</h2>
            <div class="recipe-detail-meta">
                ${mealBadge}
                <span>‚è±Ô∏è ${time} min</span>
                <span>üë• ${baseServings}</span>
                ${r.lastCooked?`<span>üìÖ ${getDaysSinceCooked(r)}d ago</span>`:''}
            </div>
            ${r.sourceUrl?`<a href="${r.sourceUrl}" target="_blank" class="source-link">üîó View Original Recipe</a>`:''}
        </div>`;
    
    if (hasIngredients) {
        content += `<div class="recipe-detail-section">
            <div class="section-header-with-multiplier">
                <h3 class="recipe-detail-section-title">Ingredients</h3>
                <div class="serving-multiplier">
                    <label>Servings:</label>
                    <button class="multiplier-btn" onclick="adjustServings('${r.id}', -0.5)" ${multiplier <= 0.5 ? 'disabled' : ''}>‚àí</button>
                    <span class="multiplier-value">${adjustedServings}</span>
                    <button class="multiplier-btn" onclick="adjustServings('${r.id}', 0.5)">+</button>
                    ${multiplier !== 1 ? `<span class="multiplier-label">(${multiplier}x)</span>` : ''}
                </div>
            </div>
            <ul class="ingredient-list">${r.ingredients.map(i => `<li class="ingredient-item">${adjustIngredientQuantity(i, multiplier)}</li>`).join('')}</ul>
        </div>`;
    }
    
    if (hasInstructions) {
        content += `<div class="recipe-detail-section">
            <h3 class="recipe-detail-section-title">Instructions</h3>
            <ol class="instruction-list">${r.instructions.map(s=>`<li class="instruction-item">${s}</li>`).join('')}</ol>
        </div>`;
    }
    
    if (!hasIngredients && !hasInstructions && r.sourceUrl) {
        content += `<div class="recipe-detail-section">
            <div class="empty-details">
                <p>üìù Recipe details not yet added.</p>
                <p>Visit the original recipe to see full ingredients and instructions, then add them here!</p>
                <a href="${r.sourceUrl}" target="_blank" class="btn btn-primary" style="margin-top: var(--space-md);">View Original Recipe</a>
            </div>
        </div>`;
    }
    
    content += `<div class="modal-footer">
        <button class="btn btn-secondary" onclick="openEditRecipeModal('${r.id}')">‚úèÔ∏è Edit</button>
        <button class="btn btn-danger" onclick="deleteRecipe('${r.id}')">üóëÔ∏è Delete</button>
        <button class="btn btn-primary" onclick="cookRecipe('${r.id}');closeModal('recipe-detail-modal')">üç≥ Cooked</button>
    </div>`;
    
    document.getElementById('recipe-detail-content').innerHTML = content;
}

function adjustServings(id, delta) {
    const r = appData.recipes.find(x => x.id === id);
    if (!r) return;
    
    currentRecipeMultiplier = Math.max(0.5, currentRecipeMultiplier + delta);
    renderRecipeDetailContent(r, currentRecipeMultiplier);
}

function adjustIngredientQuantity(ingredient, multiplier) {
    if (multiplier === 1) return ingredient;
    
    // Match quantities at the start: "1 cup", "1/2 lb", "2.5 cups", etc.
    return ingredient.replace(/^([\d./]+(?:\s*-\s*[\d./]+)?)\s*/, (match, qty) => {
        // Handle fractions like "1/2"
        let num;
        if (qty.includes('/')) {
            const parts = qty.split('/');
            num = parseFloat(parts[0]) / parseFloat(parts[1]);
        } else if (qty.includes('-')) {
            // Handle ranges like "1-2"
            const parts = qty.split('-').map(p => parseFloat(p.trim()));
            const adjusted = parts.map(p => formatQuantity(p * multiplier));
            return adjusted.join('-') + ' ';
        } else {
            num = parseFloat(qty);
        }
        
        if (isNaN(num)) return match;
        return formatQuantity(num * multiplier) + ' ';
    });
}

function formatQuantity(num) {
    // Convert to nice fractions if close
    const fractions = [
        { val: 0.25, str: '¬º' },
        { val: 0.33, str: '‚Öì' },
        { val: 0.5, str: '¬Ω' },
        { val: 0.66, str: '‚Öî' },
        { val: 0.75, str: '¬æ' }
    ];
    
    const whole = Math.floor(num);
    const frac = num - whole;
    
    if (frac < 0.1) return whole.toString();
    
    for (const f of fractions) {
        if (Math.abs(frac - f.val) < 0.08) {
            return whole > 0 ? `${whole} ${f.str}` : f.str;
        }
    }
    
    // Otherwise just round to 1 decimal
    return num % 1 === 0 ? num.toString() : num.toFixed(1);
}

function openEditRecipeModal(id) {
    const r = appData.recipes.find(x => x.id === id);
    if (!r) return;
    document.getElementById('edit-recipe-id').value = r.id;
    document.getElementById('edit-name').value = r.name;
    document.getElementById('edit-prepTime').value = r.prepTime || '';
    document.getElementById('edit-cookTime').value = r.cookTime || '';
    document.getElementById('edit-servings').value = r.servings || '';
    document.getElementById('edit-sourceUrl').value = r.sourceUrl || '';
    document.getElementById('edit-imageUrl').value = r.imageUrl || '';
    document.getElementById('edit-ingredients').value = (r.ingredients || []).join('\n');
    document.getElementById('edit-instructions').value = (r.instructions || []).join('\n');
    document.getElementById('edit-tags').value = (r.tags || []).join(', ');
    document.getElementById('edit-mealType').value = r.mealType || 'dinner';
    document.getElementById('edit-image-preview').innerHTML = r.imageUrl ? `<img src="${r.imageUrl}" onerror="this.style.display='none'">` : '';
    
    // Set meal type toggle
    document.querySelectorAll('#edit-meal-type-toggle .meal-type-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.meal === (r.mealType || 'dinner'));
    });
    
    closeModal('recipe-detail-modal'); 
    openModal('edit-recipe-modal');
}

async function handleEditRecipe(event) {
    event.preventDefault();
    const fd = new FormData(event.target), id = fd.get('id');
    const updates = { 
        name: fd.get('name'), 
        prepTime: parseInt(fd.get('prepTime'))||0, 
        cookTime: parseInt(fd.get('cookTime'))||0, 
        servings: parseInt(fd.get('servings'))||4, 
        sourceUrl: fd.get('sourceUrl')||'', 
        imageUrl: fd.get('imageUrl')||'',
        mealType: fd.get('mealType') || 'dinner',
        ingredients: fd.get('ingredients').split('\n').filter(i=>i.trim()).map(applySubstitutions),
        instructions: fd.get('instructions').split('\n').filter(i=>i.trim()),
        tags: fd.get('tags').split(',').map(t=>t.trim()).filter(t=>t)
    };
    await FirebaseDB.updateRecipe(id, updates);
    const r = appData.recipes.find(x => x.id === id);
    if (r) Object.assign(r, updates);
    closeModal('edit-recipe-modal'); showToast('Updated!', 'success'); showSyncIndicator('Synced ‚úì'); renderRecipesView(); renderDailyView();
}

async function deleteRecipe(id) {
    if (!confirm('Delete this recipe?')) return;
    await FirebaseDB.deleteRecipe(id);
    appData.recipes = appData.recipes.filter(r => r.id !== id);
    Object.keys(appData.weeklyPlan).forEach(k => { 
        if (Array.isArray(appData.weeklyPlan[k])) {
            appData.weeklyPlan[k] = appData.weeklyPlan[k].filter(rid => rid !== id);
        } else {
            appData.weeklyPlan[k].lunch = (appData.weeklyPlan[k].lunch || []).filter(rid => rid !== id);
            appData.weeklyPlan[k].dinner = (appData.weeklyPlan[k].dinner || []).filter(rid => rid !== id);
        }
    });
    await FirebaseDB.saveWeeklyPlan(appData.weeklyPlan);
    closeModal('recipe-detail-modal'); showToast('Deleted', 'success'); showSyncIndicator('Synced ‚úì'); renderRecipesView();
}

// ===== ADD RECIPE =====
async function handleAddRecipe(event) {
    event.preventDefault();
    const fd = new FormData(event.target);
    const recipe = { 
        name: fd.get('name'), 
        prepTime: parseInt(fd.get('prepTime'))||0, 
        cookTime: parseInt(fd.get('cookTime'))||0, 
        servings: parseInt(fd.get('servings'))||4, 
        mealType: fd.get('mealType') || 'dinner',
        ingredients: fd.get('ingredients').split('\n').filter(i=>i.trim()).map(applySubstitutions), 
        instructions: fd.get('instructions').split('\n').filter(i=>i.trim()), 
        tags: fd.get('tags').split(',').map(t=>t.trim()).filter(t=>t), 
        sourceUrl: fd.get('sourceUrl')||'', 
        imageUrl: fd.get('imageUrl')||'', 
        favorite: false, 
        lastCooked: null 
    };
    const newRecipe = await FirebaseDB.addRecipe(recipe);
    appData.recipes.push(newRecipe);
    closeModal('add-recipe-modal'); showToast(`Added "${recipe.name}"!`, 'success'); showSyncIndicator('Synced ‚úì'); renderRecipesView();
}

// ===== URL IMPORT =====
async function importFromUrl() {
    const urlInput = document.getElementById('import-url');
    const url = urlInput.value.trim();
    const importBtn = document.getElementById('import-btn');
    
    if (!url) {
        showToast('Please enter a URL', 'error');
        return;
    }
    
    importBtn.disabled = true;
    importBtn.textContent = 'Importing...';
    
    try {
        // Try multiple CORS proxies in order
        const proxies = [
            `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
            `https://corsproxy.io/?${encodeURIComponent(url)}`,
            `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
        ];
        
        let html = null;
        let lastError = null;
        
        for (const proxyUrl of proxies) {
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) continue;
                
                const data = await response.json ? await response.json() : await response.text();
                html = typeof data === 'string' ? data : (data.contents || data);
                
                if (html && html.length > 100) break;
            } catch (e) {
                lastError = e;
                continue;
            }
        }
        
        if (!html) {
            throw lastError || new Error('All proxies failed');
        }
        
        // Parse HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Try to find JSON-LD schema
        let recipe = null;
        const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
        for (const script of scripts) {
            try {
                const json = JSON.parse(script.textContent);
                if (json['@type'] === 'Recipe') {
                    recipe = json;
                    break;
                }
                if (Array.isArray(json['@graph'])) {
                    recipe = json['@graph'].find(item => item['@type'] === 'Recipe');
                    if (recipe) break;
                }
            } catch (e) {}
        }
        
        if (recipe) {
            // Populate form with parsed data
            document.getElementById('add-name').value = recipe.name || '';
            document.getElementById('add-prepTime').value = parseTime(recipe.prepTime) || '';
            document.getElementById('add-cookTime').value = parseTime(recipe.cookTime) || '';
            document.getElementById('add-servings').value = parseServings(recipe.recipeYield) || 4;
            document.getElementById('add-sourceUrl').value = url;
            
            if (recipe.image) {
                const imgUrl = Array.isArray(recipe.image) ? recipe.image[0] : (typeof recipe.image === 'object' ? recipe.image.url : recipe.image);
                document.getElementById('add-imageUrl').value = imgUrl || '';
            }
            
            // Ingredients
            if (recipe.recipeIngredient) {
                document.getElementById('add-ingredients').value = recipe.recipeIngredient.map(applySubstitutions).join('\n');
            }
            
            // Instructions
            if (recipe.recipeInstructions) {
                let instructions = [];
                if (Array.isArray(recipe.recipeInstructions)) {
                    instructions = recipe.recipeInstructions.map(i => typeof i === 'string' ? i : i.text).filter(Boolean);
                }
                document.getElementById('add-instructions').value = instructions.join('\n');
            }
            
            // Tags
            const tags = [];
            if (recipe.recipeCategory) tags.push(...(Array.isArray(recipe.recipeCategory) ? recipe.recipeCategory : [recipe.recipeCategory]));
            if (recipe.recipeCuisine) tags.push(...(Array.isArray(recipe.recipeCuisine) ? recipe.recipeCuisine : [recipe.recipeCuisine]));
            document.getElementById('add-tags').value = tags.join(', ');
            
            showToast('Recipe imported! Review and save.', 'success');
        } else {
            // Couldn't parse - just set the URL
            document.getElementById('add-sourceUrl').value = url;
            
            // Try to get title from page
            const title = doc.querySelector('h1, h2, .recipe-title, [class*="title"]');
            if (title) {
                document.getElementById('add-name').value = title.textContent.trim();
            }
            
            showToast('Could not auto-parse recipe. URL saved - please fill in details manually.', 'default');
        }
    } catch (error) {
        console.error('Import error:', error);
        document.getElementById('add-sourceUrl').value = url;
        showToast('Could not fetch recipe. URL saved - please fill in details manually.', 'error');
    }
    
    importBtn.disabled = false;
    importBtn.textContent = 'Import';
}

function parseTime(isoTime) {
    if (!isoTime) return 0;
    const match = isoTime.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
    if (match) {
        return (parseInt(match[1] || 0) * 60) + parseInt(match[2] || 0);
    }
    return 0;
}

function parseServings(yield_) {
    if (!yield_) return 4;
    if (typeof yield_ === 'number') return yield_;
    const match = String(yield_).match(/\d+/);
    return match ? parseInt(match[0]) : 4;
}

function applySubstitutions(ing) {
    // First, clean up any checkbox characters, bullet points, or other paste artifacts
    let cleaned = cleanIngredientText(ing);
    
    if (!cleaned) return '';
    
    // Then apply dietary substitutions
    return cleaned
        .replace(/\b(milk)\b/gi,'goat milk')
        .replace(/\b(cream)\b(?!.*coconut)/gi,'coconut cream')
        .replace(/\b(butter)\b(?!.*ghee)/gi,'ghee')
        .replace(/\b(cheese)\b/gi,'goat cheese')
        .replace(/\b(yogurt)\b/gi,'coconut yogurt')
        .replace(/\b(vegetable oil|canola oil|sunflower oil|safflower oil|soybean oil)\b/gi,'avocado oil')
        .replace(/\b(all-purpose flour|wheat flour|bread flour)\b/gi,'gluten-free flour')
        .replace(/\b(soy sauce)\b/gi,'coconut aminos');
}

// ===== INIT =====
async function initializeApp() {
    try {
        const [recipes, plan, settings] = await Promise.all([FirebaseDB.initializeDefaultRecipes(), FirebaseDB.loadWeeklyPlan(), FirebaseDB.loadSettings()]);
        appData.recipes = recipes; 
        appData.weeklyPlan = plan; 
        appData.checkedItems = settings.checkedItems || [];
        appData.pantryStock = settings.pantryStock || [];
        initNavigation(); renderDailyView();
        document.getElementById('loading-screen').classList.add('hidden');
    } catch (e) { console.error(e); showToast('Failed to load', 'error'); document.getElementById('loading-screen').classList.add('hidden'); }
}

document.addEventListener('DOMContentLoaded', () => setTimeout(initializeApp, 500));
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); }));
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active')); });

    </script>
</body>
</html>
